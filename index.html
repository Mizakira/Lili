<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ventas y Presupuesto</title>
    <!-- Tailwind CSS CDN para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos generales para un fondo más profesional y pastel con un sutil degradado */
        .min-h-screen {
            background: linear-gradient(135deg, #f0f4f8, #e8f0f7); /* Degradado suave de gris azulado */
        }
        /* Contenedor principal más elegante */
        .main-container {
            background-color: #ffffff;
            border-radius: 1rem; /* Más redondeado */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Sombra más suave y extendida */
            padding: 2.5rem; /* Más espacio interno */
        }

        /* Botones con estilo profesional */
        button {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem; /* Menos redondeado para un look más serio */
            font-weight: 600; /* Semi-bold */
            letter-spacing: 0.03em; /* Ligero espaciado para mejor legibilidad */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Sombra inicial sutil */
        }
        button:hover {
            transform: translateY(-4px); /* Efecto sutil de elevación al pasar el cursor */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Sombra al hover más pronunciada pero suave */
        }

        /* Campos de entrada y selects más limpios */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            border-radius: 1rem; /* Bordes muy suaves */
            border: 1px solid #d1dae8; /* Un tono de gris azulado muy claro para el borde */
            padding: 0.9rem 1.4rem; /* Relleno uniforme y generoso */
            font-size: 1.05rem; /* Tamaño de fuente ligeramente más grande */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #93c5fd; /* Un tono de azul pastel brillante para el foco */
            box-shadow: 0 0 0 5px rgba(147, 197, 253, 0.35); /* Anillo de foco suave y más amplio */
            outline: none;
        }
        textarea {
            resize: vertical;
        }

        /* Estilos para el modal de confirmación, más suave y elevado */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Fondo más oscuro para el modal */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 3rem; /* Más padding */
            border-radius: 1rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px; /* Más ancho */
            width: 90%;
            text-align: center;
        }
        .modal-content p {
            font-size: 1.15rem; /* Texto más grande en el modal */
            line-height: 1.6;
            color: #374151; /* Color de texto más definido */
        }

        /* Estilos específicos para los mensajes de notificación con pasteles más vibrantes */
        .message-box {
            position: fixed;
            top: 1.5rem; /* Un poco más abajo del borde */
            right: 1.5rem;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem; /* Más redondeado */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            font-weight: 500; /* Medium weight */
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999; /* Debajo del modal */
        }
        .message-box-close {
            background: none;
            border: none;
            font-size: 1.8rem; /* Tamaño de la 'x' */
            line-height: 1;
            padding: 0;
            margin-left: 1rem;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .message-box-close:hover {
            opacity: 1;
        }

        /* Estilos para los títulos y texto */
        .main-heading {
            font-size: 3rem; /* Título principal más grande */
            font-weight: 800; /* Extra-bold */
            color: #2d3748; /* Un gris oscuro profundo */
            letter-spacing: -0.04em; /* Espaciado más sutil */
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.08); /* Sombra más pronunciada para profundidad */
            display: flex; /* Para alinear icono */
            align-items: center; /* Para alinear icono */
            justify-content: center; /* Centrar contenido horizontalmente */
        }
        .main-heading svg {
            margin-right: 1.5rem; /* Espacio entre icono y texto */
            stroke-width: 3.5; /* Grosor de línea para los iconos */
            color: #4a5568; /* Color para el icono del título principal */
        }
        .section-heading {
            font-size: 2.2rem; /* Títulos de sección grandes */
            font-weight: 700; /* Bold */
            color: #374151; /* Un gris azulado oscuro para los encabezados de sección */
            margin-bottom: 2rem; /* Más espacio inferior */
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e7ee; /* Línea más definida */
            display: flex; /* Para alinear icono */
            align-items: center; /* Para alinear icono */
            justify-content: space-between; /* To space out title and button */
        }
        .section-heading-title {
            display: flex;
            align-items: center;
        }
        .section-heading-title svg {
            margin-right: 1.2rem; /* Espacio entre icono y texto */
            stroke-width: 3; /* Grosor de línea para los iconos de sección */
        }
        .sub-heading {
            font-size: 1.6rem; /* Subtítulos de cards ligeramente más grandes */
            font-weight: 600; /* Semi-bold */
            color: #ffffff; /* Blanco para mejor contraste en tarjetas pastel */
            display: flex; /* Para alinear icono */
            align-items: center; /* Para alinear icono */
        }
        .sub-heading svg {
            margin-right: 1rem;
            stroke-width: 2.8; /* Grosor de línea para iconos de subtítulos */
        }
        .card-value {
            font-size: 3.5rem; /* Valores grandes en las cards */
            font-weight: 700;
            color: #ffffff;
        }
        .card-currency {
            font-size: 2.4rem; /* Tamaño de la moneda en las cards */
            font-weight: 600;
            color: #ffffff;
        }
        .card-secondary-value {
            font-size: 1.45rem; /* Valores secundarios en las cards */
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95); /* Blanco casi opaco */
        }
        
        /* Ajustes para tablas con un look más suave y flotante */
        table {
            width: 100%;
            border-collapse: separate; /* Permite border-spacing */
            border-spacing: 0 0.5rem; /* REDUCIDO: Menos espaciado entre filas */
        }
        th, td {
            padding: 0.9rem 1.2rem; /* REDUCIDO: Menos padding para celdas */
            text-align: left;
            border-bottom: none; /* Eliminar borde inferior de celdas para un look flotante */
        }
        thead th {
            background-color: #e6f0fa; /* Fondo muy claro azulado para encabezados */
            font-size: 0.8rem; /* REDUCIDO: Tamaño de fuente más pequeño */
            font-weight: 700;
            color: #5a67d8; /* Un azul más vibrante para los encabezados */
            text-transform: uppercase;
            letter-spacing: 0.1em; /* Más espaciado entre letras */
            border-bottom: 2px solid #c3daee; /* Borde inferior para el thead */
            cursor: pointer; /* Indica que la columna es clicable */
            user-select: none; /* Evita selección de texto al hacer clic rápido */
        }
        thead th:hover {
            background-color: #dbe8f5; /* Fondo más oscuro al pasar el cursor */
        }
        tbody tr {
            background-color: #ffffff; /* Fondo blanco para las filas */
            border-radius: 1rem; /* Bordes redondeados para las filas */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); /* Sombra sutil para un efecto "flotante" */
            transition: all 0.25s ease-in-out;
        }
        tbody td {
            font-size: 0.9rem; /* REDUCIDO: Tamaño de fuente en celdas del cuerpo */
        }
        tbody tr:hover {
            background-color: #f7f9fc; /* Hover más claro y sutil */
            transform: translateY(-3px); /* Pequeña elevación al hover */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        tbody tr:last-child {
            margin-bottom: 0;
        }
        .overflow-x-auto {
            border-radius: 1.5rem; /* Redondeado para la tabla completa */
            border: none; /* Eliminar el borde principal de la tabla */
            padding: 0.5rem; /* Espaciado interno para la tabla */
        }

        /* Estilos para los botones de modo de calculadora */
        .calculator-mode-button {
            border-radius: 0.75rem; /* Más redondeado para las pestañas */
            padding: 0.8rem 1.8rem; /* Relleno cómodo */
            font-weight: 700; /* Más audaz */
            font-size: 1.15rem; /* Tamaño de fuente más grande */
            letter-spacing: 0.02em; /* Espaciado sutil */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* Sombra para las pestañas */
            transition: all 0.25s ease-in-out;
        }
        .calculator-mode-button svg {
            stroke-width: 2.5;
            margin-right: 0.8rem;
        }
        .calculator-mode-button.active {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); /* Sombra más fuerte para la activa */
            transform: translateY(-2px); /* Ligeramente levantada */
        }
        /* Estilos para la paginación */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            gap: 0.75rem;
        }
        .pagination-button {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .pagination-button:hover:not(:disabled) {
            background-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN para transformar JSX a JavaScript en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Script de la aplicación React (Babel transpilado) -->
    <script type="text/babel">
        // Importa los hooks de React
        const { useState, useEffect, useCallback, useMemo } = React;

        // Componente para el modal de confirmación
        const ConfirmModal = ({ message, onConfirm, onCancel }) => {
            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <p className="text-gray-700 mb-12">{message}</p>
                        <div className="flex justify-center space-x-8">
                            <button
                                onClick={onCancel}
                                className="px-9 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50 text-xl font-medium"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={onConfirm}
                                className="px-9 py-4 bg-rose-400 text-white rounded-xl hover:bg-rose-500 focus:outline-none focus:ring-4 focus:ring-rose-300 focus:ring-opacity-50 text-xl font-medium"
                            >
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente para la caja de mensajes (notificaciones)
        const MessageBox = ({ message, type, onClose }) => {
            let bgColor = '';
            let textColor = '';
            switch (type) {
                case 'success':
                    bgColor = 'bg-emerald-200';
                    textColor = 'text-emerald-800';
                    break;
                case 'error':
                    bgColor = 'bg-rose-200';
                    textColor = 'text-rose-800';
                    break;
                case 'info':
                    bgColor = 'bg-blue-200';
                    textColor = 'text-blue-800';
                    break;
                case 'warning':
                    bgColor = 'bg-amber-200';
                    textColor = 'text-amber-800';
                    break;
                default:
                    bgColor = 'bg-gray-200';
                    textColor = 'text-gray-800';
            }

            return (
                <div className={`message-box ${bgColor} ${textColor}`}>
                    <span>{message}</span>
                    <button onClick={onClose} className="message-box-close">
                        &times;
                    </button>
                </div>
            );
        };


        // Constante para definir cuántos elementos por página
        const ITEMS_PER_PAGE = 10;

        // Componente React App completo
        const App = () => {
            // Estado para la tasa de cambio, cargada desde localStorage
            const [exchangeRate, setExchangeRate] = useState(() => {
                const savedRate = localStorage.getItem('exchangeRate');
                return savedRate ? parseFloat(savedRate) : 36.5; // Valor por defecto si no hay nada guardado
            });

            // Estados para ventas, cargados desde localStorage
            const [sales, setSales] = useState(() => {
                const savedSales = localStorage.getItem('sales');
                // Ensure backward compatibility if old sales data exists without 'items' array
                if (savedSales) {
                    const parsedSales = JSON.parse(savedSales);
                    return parsedSales.map(sale => {
                        // If sale doesn't have 'items' array, convert it to the new structure
                        if (!sale.items && sale.product && sale.quantity && sale.amount && sale.currency && sale.unitType) {
                            return {
                                ...sale,
                                items: [{
                                    product: sale.product,
                                    quantity: sale.quantity,
                                    amount: sale.amount,
                                    currency: sale.currency,
                                    unitType: sale.unitType
                                }]
                            };
                        }
                        // Ensure sale.items is always an array, even if it was stored as null/undefined
                        if (!sale.items) {
                            return { ...sale, items: [] };
                        }
                        return sale;
                    });
                }
                return [];
            });

            // Estados para gastos, cargados desde localStorage
            const [expenses, setExpenses] = useState(() => {
                const savedExpenses = localStorage.getItem('expenses');
                return savedExpenses ? JSON.parse(savedExpenses) : [];
            });
            
            // Estado para ventas a crédito (generalizado)
            const [creditSales, setCreditSales] = useState(() => {
                const savedCreditSales = localStorage.getItem('creditSales'); // Changed from cheeseCreditSales
                if (savedCreditSales) {
                    const parsedSales = JSON.parse(savedCreditSales);
                    return parsedSales.map(sale => ({
                        ...sale,
                        paidAmount: sale.paidAmount !== undefined ? sale.paidAmount : 0,
                        status: sale.status || 'Pendiente'
                    }));
                }
                return [];
            });

            // Estados del formulario de ventas para múltiples productos
            const [saleDate, setSaleDate] = useState('');
            const [saleItems, setSaleItems] = useState([{ product: '', quantity: '', amount: '', currency: 'USD', unitType: 'unidades' }]);
            const [salePaymentMethod, setSalePaymentMethod] = useState('');        
            const [saleOperationNumber, setSaleOperationNumber] = useState('');        
            // Nuevo estado para el tipo de venta (unidades o peso) - this now applies per item
            // Retaining saleTypeForSale to control the default type for new items
            const [saleTypeForSale, setSaleTypeForSale] = useState('unidades');

            // Estados del formulario de gastos
            const [expenseDate, setExpenseDate] = useState('');
            const [expenseCategory, setExpenseCategory] = useState('');
            const [expenseAmount, setExpenseAmount] = useState('');        
            const [expenseCurrency, setExpenseCurrency] = useState('USD');        
            // Removed expensePaymentMethod and expenseOperationNumber from state as they are not used in expense form

            // ESTADOS para la Calculadora de Precios de Venta por Unidad (General)
            const [calculatorMode, setCalculatorMode] = useState('calculateSellingPrice');        
            const [totalCostPrice, setTotalCostPrice] = useState('');        
            const [purchaseQuantity, setPurchaseQuantity] = useState('');        
            const [purchaseMeasurementUnit, setPurchaseMeasurementUnit] = useState('unidades');        
            const [profitPercentage, setProfitPercentage] = useState('');        
            
            const [desiredSellingPriceInput, setDesiredSellingPriceInput] = useState('');        
            const [desiredSellingPriceCurrency, setDesiredSellingPriceCurrency] = useState('USD');        
            
            const [calculatedCostPerUnit, setCalculatedCostPerUnit] = useState(null);        
            const [calculatedSellingPricePerUnit, setCalculatedSellingPricePerUnit] = useState(null);        
            const [calculatedProfitPercentageResult, setCalculatedProfitPercentageResult] = useState(null);        

            // Estado para la calculadora de Queso
            const [cheeseWeightGrams, setCheeseWeightGrams] = useState('');
            const [cheesePricePerKiloUSD, setCheesePricePerKiloUSD] = useState(''); // Precio por kilo para la calculadora de queso
            const [calculatedCheesePriceUSD, setCalculatedCheesePriceUSD] = useState(null);
            const [calculatedCheesePriceVES, setCalculatedCheesePriceVES] = useState(null);
            
            // Nuevos estados para el formulario de venta a crédito (generalizado)
            const [creditCustomerName, setCreditCustomerName] = useState('');
            const [creditProductName, setCreditProductName] = useState(''); // Nuevo: para seleccionar el producto
            const [creditQuantity, setCreditQuantity] = useState(''); // Nueva: cantidad del producto
            const [creditAmountPerUnit, setCreditAmountPerUnit] = useState(''); // Nuevo: monto por unidad/gramo
            const [creditCurrencyPerUnit, setCreditCurrencyPerUnit] = useState('USD'); // Nuevo: moneda del monto por unidad/gramo
            const [creditUnitType, setCreditUnitType] = useState('unidades'); // Nuevo: tipo de unidad del producto (derivado del inventario)

            const [payingCreditSaleId, setPayingCreditSaleId] = useState(null); // ID de la venta a crédito que se está pagando
            const [paymentAmount, setPaymentAmount] = useState('');

            // Estado para mensajes de usuario
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');        
            const [showMessageBox, setShowMessageBox] = useState(false);        

            // Nuevos estados para el modal de confirmación
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [onConfirmAction, setOnConfirmAction] = useState(null);        

            // Estados de ordenación para ventas
            const [salesSortColumn, setSalesSortColumn] = useState('date');
            const [salesSortDirection, setSalesSortDirection] = useState('desc'); // 'asc' o 'desc'
            // Estados de paginación para ventas
            const [currentSalesPage, setCurrentSalesPage] = useState(1);
            // Estados de búsqueda y filtro para ventas
            const [salesSearchTerm, setSalesSearchTerm] = useState('');
            const [salesStartDate, setSalesStartDate] = useState('');
            const [salesEndDate, setSalesEndDate] = useState('');

            // Estados de ordenación para gastos
            const [expensesSortColumn, setExpensesSortColumn] = useState('date');
            const [expensesSortDirection, setExpensesSortDirection] = useState('desc'); // 'asc' o 'desc'
            // Estados de paginación para gastos
            const [currentExpensesPage, setCurrentExpensesPage] = useState(1);
            // Estados de búsqueda y filtro para gastos
            const [expensesSearchTerm, setExpensesSearchTerm] = useState('');
            const [expensesStartDate, setExpensesStartDate] = useState('');
            const [expensesEndDate, setExpensesEndDate] = useState('');

            // Estados de ordenación para ventas a crédito (generalizado)
            const [creditSalesSortColumn, setCreditSalesSortColumn] = useState('date'); // Changed from cheeseCreditSortColumn
            const [creditSalesSortDirection, setCreditSalesSortDirection] = useState('desc');
            // Estados de paginación para ventas a crédito (generalizado)
            const [currentCreditSalesPage, setCurrentCreditSalesPage] = useState(1); // Changed from currentCheeseCreditPage
            // Estados de búsqueda y filtro para ventas a crédito (generalizado)
            const [creditSalesSearchTerm, setCreditSalesSearchTerm] = useState(''); // Changed from cheeseCreditSearchTerm
            const [creditSalesStatusFilter, setCreditSalesStatusFilter] = useState('Todos'); // Changed from cheeseCreditStatusFilter
            // Estado para la edición de ventas a crédito
            const [editingCreditSaleId, setEditingCreditSaleId] = useState(null);


            // NUEVOS ESTADOS PARA INVENTARIO
            const [inventory, setInventory] = useState(() => {
                const savedInventory = localStorage.getItem('inventory');
                // Add new fields for existing data if they don't exist
                if (savedInventory) {
                    const parsedInventory = JSON.parse(savedInventory);
                    return parsedInventory.map(item => ({
                        ...item,
                        minStockAlert: item.minStockAlert !== undefined ? item.minStockAlert : 0, // Default to 0 for no alert
                        category: item.category || 'General', // Default category
                        totalCostPurchaseCurrency: item.totalCostPurchaseCurrency || 'USD',
                        suggestedSellingPriceCurrency: item.suggestedSellingPriceCurrency || 'USD',
                    }));
                }
                return [];
            });
            const [newInventoryItem, setNewInventoryItem] = useState({
                name: '',
                stockQuantity: '',
                stockUnitType: 'unidades', // 'unidades' o 'gramos'
                totalCostPurchase: '', // Nuevo campo para el costo total de compra
                totalCostPurchaseCurrency: 'USD', // Nueva moneda para el costo total de compra
                suggestedSellingPrice: '', // Nuevo campo para el precio de venta sugerido
                suggestedSellingPriceCurrency: 'USD', // Nueva moneda para el precio de venta sugerido
                minStockAlert: '', // Nuevo campo para alerta de stock mínimo
                category: 'General', // Nueva categoría
            });
            const [editingInventoryItem, setEditingInventoryItem] = useState(null); // null o el ID del item a editar

            // Estados de ordenación para inventario
            const [inventorySortColumn, setInventorySortColumn] = useState('name');
            const [inventorySortDirection, setInventorySortDirection] = useState('asc');
            // Estados de paginación para inventario
            const [currentInventoryPage, setCurrentInventoryPage] = useState(1);
            // Estados de búsqueda y filtro para inventario
            const [inventorySearchTerm, setInventorySearchTerm] = useState('');
            const [inventoryCategoryFilter, setInventoryCategoryFilter] = useState('Todas');

            // NUEVOS ESTADOS PARA FILTROS DE REPORTES
            const [reportStartDate, setReportStartDate] = useState('');
            const [reportEndDate, setReportEndDate] = useState('');


            // Muestra mensajes temporales al usuario
            const showMessage = (msg, type) => {
                setMessage(msg);
                setMessageType(type);
                setShowMessageBox(true);        
                setTimeout(() => {
                    setShowMessageBox(false);        
                    setMessage('');        
                    setMessageType('');
                }, 5000);        
            };

            // Función para cerrar el mensaje manualmente
            const closeMessage = () => {
                setShowMessageBox(false);
                setMessage('');
                setMessageType('');
            };

            // Función para abrir el modal de confirmación
            const openConfirmModal = (message, callback) => {
                setModalMessage(message);
                setOnConfirmAction(() => callback);        
                setShowConfirmModal(true);
            };

            // Manejador para confirmar la acción en el modal
            const handleConfirm = () => {
                if (onConfirmAction) {
                    onConfirmAction();        
                }
                setShowConfirmModal(false);        
                setOnConfirmAction(null);        
            };

            // Manejador para cancelar la acción en el modal
            const handleCancel = () => {
                setShowConfirmModal(false);        
                setOnConfirmAction(null);        
            };

            // Guarda la tasa de cambio en localStorage cada vez que cambia
            useEffect(() => {
                localStorage.setItem('exchangeRate', exchangeRate.toString());
            }, [exchangeRate]);

            // Guarda las ventas en localStorage cada vez que cambian
            useEffect(() => {
                localStorage.setItem('sales', JSON.stringify(sales));
            }, [sales]);

            // Guarda los gastos en localStorage cada vez que cambian
            useEffect(() => {
                localStorage.setItem('expenses', JSON.stringify(expenses));
            }, [expenses]);

            // Guarda las ventas a crédito en localStorage cada vez que cambian
            useEffect(() => {
                localStorage.setItem('creditSales', JSON.stringify(creditSales)); // Changed from cheeseCreditSales
            }, [creditSales]);

            // Guarda el inventario en localStorage cada vez que cambia
            useEffect(() => {
                localStorage.setItem('inventory', JSON.stringify(inventory));
            }, [inventory]);


            // Manejador para añadir un nuevo producto a la lista de venta actual
            const handleAddSaleItem = () => {
                setSaleItems([...saleItems, { product: '', quantity: '', amount: '', currency: 'USD', unitType: saleTypeForSale }]);
            };

            // Manejador para eliminar un producto de la lista de venta actual
            const handleRemoveSaleItem = (indexToRemove) => {
                setSaleItems(saleItems.filter((_, index) => index !== indexToRemove));
            };

            // Manejador para actualizar un campo de un producto específico en la lista de venta
            const handleSaleItemChange = (index, field, value) => {
                const updatedItems = saleItems.map((item, idx) => {
                    if (index === idx) {
                        if (field === 'product') {
                            const selectedInventoryItem = inventory.find(invItem => invItem.name === value);
                            if (selectedInventoryItem) {
                                return {
                                    ...item,
                                    product: value,
                                    unitType: selectedInventoryItem.stockUnitType,
                                    // Optionally pre-fill amount with suggested selling price
                                    amount: selectedInventoryItem.suggestedSellingPrice || '',
                                    currency: selectedInventoryItem.suggestedSellingPriceCurrency || 'USD' // Use the currency from inventory
                                };
                            }
                        }
                        // If changing unitType for a peso_g item, currency must be USD
                        if (field === 'unitType' && value === 'peso_g') {
                            return { ...item, [field]: value, currency: 'USD' };
                        }
                        return { ...item, [field]: value };
                    }
                    return item;
                });
                setSaleItems(updatedItems);
            };

            // Manejador para añadir una nueva venta
            const handleAddSale = (e) => {
                e.preventDefault();        

                // Validate overall sale properties first
                if (!saleDate) {
                    showMessage('La fecha de venta no puede estar vacía.', 'error');
                    return;
                }
                if (!salePaymentMethod) {
                    showMessage('Por favor, selecciona un método de pago para la venta.', 'error');
                    return;
                }
                if (salePaymentMethod === 'Pago Móvil' && !saleOperationNumber.trim()) {
                    showMessage('El número de operación es obligatorio para Pago Móvil.', 'error');
                    return;
                }
                
                if (saleItems.length === 0) {
                    showMessage('Debe agregar al menos un producto para registrar la venta.', 'error');
                    return;
                }

                // Validate each item in saleItems and check inventory
                const validatedItems = [];
                const updatedInventory = [...inventory]; // Create a mutable copy

                for (const item of saleItems) {
                    if (!item.product.trim()) {
                        showMessage('El nombre de un producto no puede estar vacío.', 'error');
                        return;
                    }
                    if (!item.quantity) {
                        showMessage('La cantidad de un producto no puede estar vacía.', 'error');
                        return;
                    }
                    const parsedQuantity = parseFloat(item.quantity);
                    if (isNaN(parsedQuantity) || parsedQuantity <= 0) {
                        showMessage('La cantidad debe ser un número válido mayor que cero para todos los productos.', 'error');
                        return;
                    }

                    if (!item.amount) {
                        showMessage('El monto unitario de un producto no puede estar vacío.', 'error');
                        return;
                    }
                    const parsedAmount = parseFloat(item.amount);
                    if (isNaN(parsedAmount) || parsedAmount <= 0) {
                        showMessage('El monto unitario debe ser un número válido mayor que cero para todos los productos.', 'error');
                        return;
                    }

                    // Inventory deduction logic
                    const inventoryIndex = updatedInventory.findIndex(
                        invItem => invItem.name.toLowerCase() === item.product.trim().toLowerCase() &&
                                   (invItem.stockUnitType === item.unitType || (invItem.stockUnitType === 'gramos' && item.unitType === 'peso_g'))
                    );

                    if (inventoryIndex === -1) {
                        showMessage(`El producto "${item.product.trim()}" no se encontró en el inventario con la unidad de medida correcta.`, 'error');
                        return;
                    }

                    const currentStock = updatedInventory[inventoryIndex].stockQuantity;
                    if (currentStock < parsedQuantity) {
                        showMessage(`Stock insuficiente para "${item.product.trim()}". Disponible: ${currentStock.toFixed(2)} ${updatedInventory[inventoryIndex].stockUnitType}.`, 'error');
                        return;
                    }

                    // Deduct from stock
                    updatedInventory[inventoryIndex].stockQuantity -= parsedQuantity;

                    // Adjust product label if it's a 'peso' sale type
                    let storedProductLabel = item.product.trim();
                    let itemCurrency = item.currency;

                    if (item.unitType === 'peso_g') {
                        storedProductLabel = `${item.product.trim()} (Peso)`;
                        itemCurrency = 'USD'; // Price per kilo is always USD
                    }

                    validatedItems.push({
                        product: storedProductLabel,
                        quantity: parsedQuantity,
                        amount: parsedAmount,
                        currency: itemCurrency,
                        unitType: item.unitType
                    });
                }

                const newSale = {
                    id: Date.now(),        
                    date: saleDate,
                    paymentMethod: salePaymentMethod,        
                    operationNumber: salePaymentMethod === 'Pago Móvil' ? saleOperationNumber.trim() : '',        
                    items: validatedItems, // Store the array of validated items
                };
                
                setSales(prevSales => [...prevSales, newSale]);        
                setInventory(updatedInventory); // Update inventory after successful sale
                showMessage('Venta agregada exitosamente y stock actualizado.', 'success');
                setCurrentSalesPage(1); // Reset to first page after adding new sale

                // Clear form fields
                setSaleDate('');
                setSalePaymentMethod('');        
                setSaleOperationNumber('');        
                setSaleItems([{ product: '', quantity: '', amount: '', currency: 'USD', unitType: 'unidades' }]); // Reset to one empty item
                setSaleTypeForSale('unidades'); // Reset sale type radio to default
            };

            // Manejador para añadir un nuevo gasto
            const handleAddExpense = (e) => {
                e.preventDefault();        

                const expenseAmountVal = expenseAmount.trim();

                if (!expenseDate) {
                    showMessage('La fecha de gasto no puede estar vacía.', 'error');
                    return;
                }
                if (!expenseCategory.trim()) {
                    showMessage('La categoría de gasto no puede estar vacía.', 'error');
                    return;
                }
                if (!expenseAmountVal) {
                    showMessage('El monto de gasto no puede estar vacío.', 'error');
                    return;
                }
                const parsedExpenseAmount = parseFloat(expenseAmountVal);
                if (isNaN(parsedExpenseAmount) || parsedExpenseAmount <= 0) {
                    showMessage('El monto de gasto debe ser un número válido mayor que cero.', 'error');
                    return;
                }
                
                const newExpense = {
                    id: Date.now(),        
                    date: expenseDate,
                    category: expenseCategory.trim(),
                    amount: parsedExpenseAmount,
                    currency: expenseCurrency,    
                };
                
                setExpenses(prevExpenses => [...prevExpenses, newExpense]);        
                showMessage('Gasto agregado exitosamente.', 'success');
                setCurrentExpensesPage(1); // Reset to first page after adding new expense

                setExpenseDate('');
                setExpenseCategory('');
                setExpenseAmount('');
                setExpenseCurrency('USD');        
            };
            
            // Manejador para añadir o actualizar una venta a crédito (generalizado)
            const handleAddOrUpdateCreditSale = (e) => {
                e.preventDefault();
                const parsedCreditQuantity = parseFloat(creditQuantity);
                const parsedCreditAmountPerUnit = parseFloat(creditAmountPerUnit);

                if (!creditCustomerName.trim()) {
                    showMessage('El nombre del cliente no puede estar vacío.', 'error');
                    return;
                }
                if (!creditProductName) {
                    showMessage('Por favor, selecciona un producto para la venta a crédito.', 'error');
                    return;
                }
                if (isNaN(parsedCreditQuantity) || parsedCreditQuantity <= 0) {
                    showMessage('Por favor, ingresa una cantidad válida (número mayor que cero).', 'error');
                    return;
                }
                if (isNaN(parsedCreditAmountPerUnit) || parsedCreditAmountPerUnit <= 0) {
                    showMessage('Por favor, ingresa un monto válido por unidad/gramo (número mayor que cero).', 'error');
                    return;
                }

                const newSelectedProduct = inventory.find(item => item.name === creditProductName);
                if (!newSelectedProduct) {
                    showMessage('Producto seleccionado no encontrado en el inventario.', 'error');
                    return;
                }

                let newTotalUSD;
                if (newSelectedProduct.stockUnitType === 'gramos' && creditUnitType === 'peso_g') {
                    newTotalUSD = (parsedCreditQuantity / 1000) * parsedCreditAmountPerUnit;
                } else {
                    newTotalUSD = parsedCreditQuantity * convertToUSD(parsedCreditAmountPerUnit, creditCurrencyPerUnit);
                }

                let updatedInventory = [...inventory]; // Create a mutable copy

                if (editingCreditSaleId) {
                    // --- EDIT MODE ---
                    const originalSale = creditSales.find(sale => sale.id === editingCreditSaleId);
                    if (!originalSale) {
                        showMessage('Venta a crédito original no encontrada para edición.', 'error');
                        return;
                    }

                    const originalProduct = inventory.find(item => item.name === originalSale.productName);
                    if (!originalProduct) {
                        // This case should ideally not happen if inventory is well-managed
                        showMessage('Producto original de la venta a crédito no encontrado en inventario. No se puede ajustar stock.', 'error');
                        return;
                    }

                    // 1. Replenish stock for the ORIGINAL sale's product and quantity
                    const originalProductIndex = updatedInventory.findIndex(item => item.id === originalProduct.id);
                    if (originalProductIndex !== -1) {
                        updatedInventory[originalProductIndex].stockQuantity += originalSale.quantity;
                    } else {
                        console.warn(`Original product ${originalProduct.name} not found in current inventory for replenishment. Skipping replenishment.`);
                    }

                    // 2. Deduct stock for the NEW sale's product and quantity
                    const newProductIndex = updatedInventory.findIndex(item => item.id === newSelectedProduct.id);
                    if (newProductIndex === -1) {
                        showMessage(`El producto "${newSelectedProduct.name}" no se encontró en el inventario para la nueva deducción.`, 'error');
                        // Revert original replenishment if new product not found
                        if (originalProductIndex !== -1) {
                            updatedInventory[originalProductIndex].stockQuantity -= originalSale.quantity;
                        }
                        return;
                    }

                    if (updatedInventory[newProductIndex].stockQuantity < parsedCreditQuantity) {
                        showMessage(`Stock insuficiente para "${newSelectedProduct.name}". Disponible: ${updatedInventory[newProductIndex].stockQuantity.toFixed(2)} ${newSelectedProduct.stockUnitType}.`, 'error');
                        // Revert original replenishment if new stock is insufficient
                        if (originalProductIndex !== -1) {
                            updatedInventory[originalProductIndex].stockQuantity -= originalSale.quantity;
                        }
                        return;
                    }
                    updatedInventory[newProductIndex].stockQuantity -= parsedCreditQuantity;

                    // Update the credit sale record
                    setCreditSales(prevSales => prevSales.map(sale =>
                        sale.id === editingCreditSaleId
                            ? {
                                ...sale,
                                // Keep original date, don't update to today's date on edit
                                customerName: creditCustomerName.trim(),
                                productName: newSelectedProduct.name,
                                quantity: parsedCreditQuantity,
                                unitType: newSelectedProduct.stockUnitType,
                                amountPerUnit: parsedCreditAmountPerUnit,
                                currencyPerUnit: creditCurrencyPerUnit,
                                totalUSD: newTotalUSD,
                                // Keep paidAmount and status as they are, unless explicit change is requested
                            }
                            : sale
                    ));
                    showMessage('Venta a crédito actualizada y stock ajustado.', 'success');
                    setEditingCreditSaleId(null); // Exit edit mode

                } else {
                    // --- ADD MODE (existing logic) ---
                    const inventoryIndex = updatedInventory.findIndex(
                        invItem => invItem.name === newSelectedProduct.name && invItem.stockUnitType === newSelectedProduct.stockUnitType
                    );

                    if (inventoryIndex === -1) {
                        showMessage(`El producto "${newSelectedProduct.name}" no se encontró en el inventario con la unidad de medida correcta.`, 'error');
                        return;
                    }
                    const currentStock = updatedInventory[inventoryIndex].stockQuantity;
                    if (currentStock < parsedCreditQuantity) {
                        showMessage(`Stock insuficiente para "${newSelectedProduct.name}". Disponible: ${currentStock.toFixed(2)} ${newSelectedProduct.stockUnitType}.`, 'error');
                        return;
                    }
                    updatedInventory[inventoryIndex].stockQuantity -= parsedCreditQuantity;

                    const newCreditSale = {
                        id: Date.now(),
                        date: new Date().toISOString().slice(0, 10),
                        customerName: creditCustomerName.trim(),
                        productName: newSelectedProduct.name,
                        quantity: parsedCreditQuantity,
                        unitType: newSelectedProduct.stockUnitType,
                        amountPerUnit: parsedCreditAmountPerUnit,
                        currencyPerUnit: creditCurrencyPerUnit,
                        totalUSD: newTotalUSD,
                        paidAmount: 0,
                        status: 'Pendiente',
                    };
                    setCreditSales(prevSales => [...prevSales, newCreditSale]);
                    showMessage('Venta a crédito registrada y stock actualizado.', 'success');
                }

                setInventory(updatedInventory); // Update inventory state
                setCurrentCreditSalesPage(1); // Reset to first page

                // Clear form fields
                setCreditCustomerName('');
                setCreditProductName('');
                setCreditQuantity('');
                setCreditAmountPerUnit('');
                setCreditCurrencyPerUnit('USD');
                setCreditUnitType('unidades');
            };

            // Manejador para cargar una venta a crédito para edición
            const handleEditCreditSale = (sale) => {
                setEditingCreditSaleId(sale.id);
                setCreditCustomerName(sale.customerName);
                setCreditProductName(sale.productName);
                setCreditQuantity(sale.quantity);
                setCreditAmountPerUnit(sale.amountPerUnit);
                setCreditCurrencyPerUnit(sale.currencyPerUnit);
                setCreditUnitType(sale.unitType); // Pre-fill unit type
                showMessage('Editando venta a crédito. Modifica los campos y haz clic en "Actualizar".', 'info');
            };

            // Manejador para cancelar la edición de una venta a crédito
            const handleCancelCreditSaleEdit = () => {
                setEditingCreditSaleId(null);
                setCreditCustomerName('');
                setCreditProductName('');
                setCreditQuantity('');
                setCreditAmountPerUnit('');
                setCreditCurrencyPerUnit('USD');
                setCreditUnitType('unidades');
                showMessage('Edición de venta a crédito cancelada.', 'info');
            };

            // Manejador para registrar un pago a una venta a crédito
            const handleRegisterCreditPayment = (e) => {
                e.preventDefault();
                const parsedPaymentAmount = parseFloat(paymentAmount);

                if (isNaN(parsedPaymentAmount) || parsedPaymentAmount <= 0) {
                    showMessage('Por favor, ingresa un monto de pago válido (número mayor que cero).', 'error');
                    return;
                }

                setCreditSales(prevSales => {
                    return prevSales.map(sale => {
                        if (sale.id === payingCreditSaleId) {
                            const newPaidAmount = sale.paidAmount + parsedPaymentAmount;
                            let newStatus = sale.status;

                            if (newPaidAmount >= sale.totalUSD) {
                                newStatus = 'Pagado';
                            } else if (newPaidAmount > 0) {
                                newStatus = 'Pagado Parcial';
                            } else {
                                newStatus = 'Pendiente'; // Should not happen if parsedPaymentAmount > 0
                            }

                            return {
                                ...sale,
                                paidAmount: newPaidAmount,
                                status: newStatus,
                            };
                        }
                        return sale;
                    });
                });

                showMessage('Pago registrado exitosamente.', 'success');
                setPayingCreditSaleId(null);
                setPaymentAmount('');
            };


            // Manejador para eliminar una venta individual
            const handleDeleteSale = (id) => {
                setSales(prevSales => prevSales.filter(sale => sale.id !== id));
                showMessage('Venta eliminada.', 'success');
                // Adjust current page if the last item on it was deleted
                if (paginatedSales.length === 1 && currentSalesPage > 1) {
                    setCurrentSalesPage(currentSalesPage - 1);
                }
            };

            // Manejador para eliminar un gasto individual
            const handleDeleteExpense = (id) => {
                setExpenses(prevExpenses => prevExpenses.filter(expense => expense.id !== id));
                showMessage('Gasto eliminado.', 'success');
                    // Adjust current page if the last item on it was deleted
                if (paginatedExpenses.length === 1 && currentExpensesPage > 1) {
                    setCurrentExpensesPage(currentExpensesPage - 1);
                }
            };
            
            // Manejador para eliminar una venta a crédito individual (generalizado)
            const handleDeleteCreditSale = (id) => {
                openConfirmModal(
                    '¿Estás seguro de que quieres eliminar este registro de crédito? Esto no repondrá el inventario.',
                    () => {
                        setCreditSales(prevSales => prevSales.filter(sale => sale.id !== id));
                        showMessage('Venta a crédito eliminada.', 'success');
                        if (paginatedCreditSales.length === 1 && currentCreditSalesPage > 1) {
                            setCurrentCreditSalesPage(currentCreditSalesPage - 1);
                        }
                    }
                );
            };


            // Manejador para borrar TODO el historial de ventas
            const handleClearSales = () => {
                openConfirmModal(
                    '¿Estás seguro de que quieres borrar TODO el historial de ventas? Esta acción no se puede deshacer.',
                    () => {
                        setSales([]);        
                        localStorage.removeItem('sales');        
                        showMessage('Historial de ventas borrado.', 'success');
                        setCurrentSalesPage(1); // Reset page after clearing
                    }
                );
            };

            // Manejador para borrar TODO el historial de gastos
            const handleClearExpenses = () => {
                openConfirmModal(
                    '¿Estás seguro de que quieres borrar TODO el historial de gastos? Esta acción no se puede deshacer.',
                    () => {
                        setExpenses([]);        
                        localStorage.removeItem('expenses');        
                        showMessage('Historial de gastos borrado.', 'success');
                        setCurrentExpensesPage(1); // Reset page after clearing
                    }
                );
            };
            
            // Manejador para borrar TODO el historial de ventas a crédito (generalizado)
            const handleClearCreditSales = () => {
                openConfirmModal(
                    '¿Estás seguro de que quieres borrar TODO el historial de ventas a crédito? Esta acción no se puede deshacer.',
                    () => {
                        setCreditSales([]);
                        localStorage.removeItem('creditSales');
                        showMessage('Historial de ventas a crédito borrado.', 'success');
                        setCurrentCreditSalesPage(1); // Reset page after clearing
                    }
                );
            };


            // Manejador para calcular el precio de venta por unidad (general)
            const handleCalculateSellingPrice = (e) => {
                e.preventDefault();
                const parsedTotalCostPrice = parseFloat(totalCostPrice);
                const parsedPurchaseQuantity = parseFloat(purchaseQuantity);
                const parsedProfitPercentage = parseFloat(profitPercentage);

                if (isNaN(parsedTotalCostPrice) || parsedTotalCostPrice <= 0) {
                    showMessage('Por favor, ingresa un costo TOTAL válido (número mayor que cero).', 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);        
                    return;
                }
                if (isNaN(parsedPurchaseQuantity) || parsedPurchaseQuantity <= 0) {
                    showMessage(`Por favor, ingresa una cantidad válida de ${purchaseMeasurementUnit} (número mayor que cero).`, 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);        
                    return;
                }
                if (isNaN(parsedProfitPercentage) || parsedProfitPercentage < 0) {        
                    showMessage('Por favor, ingresa un porcentaje de ganancia válido (número mayor o igual a cero).', 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);        
                    return;
                }

                const costPerUnit = parsedTotalCostPrice / parsedPurchaseQuantity;
                const sellingPricePerUnit = costPerUnit * (1 + parsedProfitPercentage / 100);
                
                setCalculatedCostPerUnit(costPerUnit);
                setCalculatedSellingPricePerUnit(sellingPricePerUnit);
                setCalculatedProfitPercentageResult(null);        
                showMessage('Precio de venta por unidad calculado.', 'success');

                // Clear form fields after calculation
                setTotalCostPrice('');
                setPurchaseQuantity('');
                setProfitPercentage('');
                setPurchaseMeasurementUnit('unidades');
            };

            // Manejador para calcular el porcentaje de ganancia (general)
            const handleCalculateProfitPercentage = (e) => {
                e.preventDefault();
                const parsedTotalCostPrice = parseFloat(totalCostPrice);
                const parsedPurchaseQuantity = parseFloat(purchaseQuantity);
                const desiredSellingPriceInputVal = desiredSellingPriceInput.trim();

                if (isNaN(parsedTotalCostPrice) || parsedTotalCostPrice <= 0) {
                    showMessage('Por favor, ingresa un costo TOTAL válido (número mayor que cero).', 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);
                    return;
                }
                if (isNaN(parsedPurchaseQuantity) || parsedPurchaseQuantity <= 0) {
                    showMessage(`Por favor, ingresa una cantidad válida de ${purchaseMeasurementUnit} (número mayor que cero).`, 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);
                    return;
                }
                if (!desiredSellingPriceInputVal) {
                    showMessage('Por favor, ingresa el precio de venta deseado por unidad.', 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);
                    return;
                }
                const parsedDesiredSellingPrice = parseFloat(desiredSellingPriceInputVal);
                if (isNaN(parsedDesiredSellingPrice) || parsedDesiredSellingPrice <= 0) {
                    showMessage('El precio de venta deseado debe ser un número válido mayor que cero.', 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);
                    return;
                }

                const costPerUnit = parsedTotalCostPrice / parsedPurchaseQuantity;
                let sellingPriceForCalculation = parsedDesiredSellingPrice;

                // Convertir el precio de venta deseado a USD si se ingresó en VES
                if (desiredSellingPriceCurrency === 'VES') {
                    if (exchangeRate <= 0) {
                        showMessage('La tasa de cambio debe ser mayor que cero para convertir de VES a USD.', 'error');
                        setCalculatedCostPerUnit(null);
                        setCalculatedSellingPricePerUnit(null);
                        setCalculatedProfitPercentageResult(null);
                        return;
                    }
                    sellingPriceForCalculation = parsedDesiredSellingPrice / exchangeRate;
                }

                if (costPerUnit === 0) {
                    showMessage('El costo por unidad no puede ser cero para calcular el porcentaje de ganancia.', 'error');
                    setCalculatedCostPerUnit(null);
                    setCalculatedSellingPricePerUnit(null);
                    setCalculatedProfitPercentageResult(null);
                    return;
                }

                const profitPercentageCalculated = ((sellingPriceForCalculation - costPerUnit) / costPerUnit) * 100;
                
                setCalculatedCostPerUnit(costPerUnit);
                setCalculatedSellingPricePerUnit(parsedDesiredSellingPrice); // Mostrar el precio deseado en su moneda original
                setCalculatedProfitPercentageResult(profitPercentageCalculated);
                showMessage('Porcentaje de ganancia calculado.', 'success');

                // Clear form fields after calculation
                setTotalCostPrice('');
                setPurchaseQuantity('');
                setDesiredSellingPriceInput('');
                setPurchaseMeasurementUnit('unidades');
                setDesiredSellingPriceCurrency('USD');
            };

            // Manejador para la calculadora de queso (manteniendo la que estaba)
            const handleCalculateCheesePrice = (e) => {
                e.preventDefault();
                const parsedCheeseWeightGrams = parseFloat(cheeseWeightGrams);
                const parsedCheesePricePerKiloUSD = parseFloat(cheesePricePerKiloUSD);

                if (isNaN(parsedCheeseWeightGrams) || parsedCheeseWeightGrams <= 0) {
                    showMessage('Por favor, ingresa un peso válido en gramos (número mayor que cero).', 'error');
                    setCalculatedCheesePriceUSD(null);
                    setCalculatedCheesePriceVES(null);
                    return;
                }
                if (isNaN(parsedCheesePricePerKiloUSD) || parsedCheesePricePerKiloUSD <= 0) {
                    showMessage('Por favor, ingresa un precio válido por kilo en USD (número mayor que cero).', 'error');
                    setCalculatedCheesePriceUSD(null);
                    setCalculatedCheesePriceVES(null);
                    return;
                }
                if (exchangeRate <= 0) {
                    showMessage('La tasa de cambio debe ser mayor que cero para calcular en VES.', 'error');
                    setCalculatedCheesePriceUSD(null);
                    setCalculatedCheesePriceVES(null);
                    return;
                }

                const totalUSD = (parsedCheeseWeightGrams / 1000) * parsedCheesePricePerKiloUSD;
                const totalVES = totalUSD * exchangeRate;

                setCalculatedCheesePriceUSD(totalUSD);
                setCalculatedCheesePriceVES(totalVES);
                showMessage('Precio del queso calculado.', 'success');
            };

            // Función de ayuda para convertir a USD desde cualquier moneda
            const convertToUSDFromAny = useCallback((amount, currency) => {
                if (currency === 'VES') {
                    return exchangeRate > 0 ? amount / exchangeRate : 0;
                }
                return amount;
            }, [exchangeRate]);

            // Función de ayuda para convertir a VES desde USD
            const convertToVESFromUSD = useCallback((amountUSD) => {
                return amountUSD * exchangeRate;
            }, [exchangeRate]);


            // Manejador para añadir o actualizar un item en el inventario
            const handleAddOrUpdateInventoryItem = (e) => {
                e.preventDefault();
                const { name, stockQuantity, stockUnitType, totalCostPurchase, totalCostPurchaseCurrency, suggestedSellingPrice, suggestedSellingPriceCurrency, minStockAlert, category } = newInventoryItem;

                if (!name.trim()) {
                    showMessage('El nombre del producto no puede estar vacío.', 'error');
                    return;
                }
                const parsedStockQuantity = parseFloat(stockQuantity);
                if (isNaN(parsedStockQuantity) || parsedStockQuantity < 0) {
                    showMessage('La cantidad en stock debe ser un número válido mayor o igual a cero.', 'error');
                    return;
                }
                const parsedTotalCostPurchase = parseFloat(totalCostPurchase);
                if (isNaN(parsedTotalCostPurchase) || parsedTotalCostPurchase < 0) {
                    showMessage('El costo total de compra debe ser un número válido mayor o igual a cero.', 'error');
                    return;
                }
                const parsedSuggestedSellingPrice = parseFloat(suggestedSellingPrice);
                if (isNaN(parsedSuggestedSellingPrice) || parsedSuggestedSellingPrice < 0) {
                    showMessage('El precio de venta sugerido debe ser un número válido mayor o igual a cero.', 'error');
                    return;
                }
                const parsedMinStockAlert = parseFloat(minStockAlert);
                if (minStockAlert !== '' && (isNaN(parsedMinStockAlert) || parsedMinStockAlert < 0)) {
                    showMessage('La alerta de stock mínimo debe ser un número válido mayor o igual a cero.', 'error');
                    return;
                }

                // Convert totalCostPurchase to USD for internal calculation
                const totalCostPurchaseInUSD = convertToUSDFromAny(parsedTotalCostPurchase, totalCostPurchaseCurrency);

                // Calculate costPerUnit (always stored in USD)
                const calculatedCostPerUnit = parsedStockQuantity > 0 ? totalCostPurchaseInUSD / parsedStockQuantity : 0;

                if (editingInventoryItem) {
                    // Update existing item
                    setInventory(prevInventory => prevInventory.map(item =>
                        item.id === editingInventoryItem
                            ? {
                                ...item,
                                name: name.trim(),
                                stockQuantity: parsedStockQuantity,
                                stockUnitType,
                                totalCostPurchase: parsedTotalCostPurchase,
                                totalCostPurchaseCurrency,
                                costPerUnit: calculatedCostPerUnit, // Always USD
                                suggestedSellingPrice: parsedSuggestedSellingPrice,
                                suggestedSellingPriceCurrency,
                                minStockAlert: parsedMinStockAlert,
                                category,
                                lastUpdated: new Date().toISOString().slice(0, 10)
                            }
                            : item
                    ));
                    showMessage('Producto de inventario actualizado exitosamente.', 'success');
                    setEditingInventoryItem(null);
                } else {
                    // Add new item
                    // Check for duplicate product name + unit type combination
                    const isDuplicate = inventory.some(item =>
                        item.name.toLowerCase() === name.trim().toLowerCase() && item.stockUnitType === stockUnitType
                    );
                    if (isDuplicate) {
                        showMessage('Ya existe un producto con este nombre y tipo de unidad en el inventario.', 'error');
                        return;
                    }

                    const newItem = {
                        id: Date.now(),
                        name: name.trim(),
                        stockQuantity: parsedStockQuantity,
                        stockUnitType,
                        totalCostPurchase: parsedTotalCostPurchase,
                        totalCostPurchaseCurrency,
                        costPerUnit: calculatedCostPerUnit, // Always USD
                        suggestedSellingPrice: parsedSuggestedSellingPrice,
                        suggestedSellingPriceCurrency,
                        minStockAlert: parsedMinStockAlert,
                        category,
                        lastUpdated: new Date().toISOString().slice(0, 10),
                    };
                    setInventory(prevInventory => [...prevInventory, newItem]);
                    showMessage('Producto agregado al inventario exitosamente.', 'success');
                }

                // Clear form
                setNewInventoryItem({ name: '', stockQuantity: '', stockUnitType: 'unidades', totalCostPurchase: '', totalCostPurchaseCurrency: 'USD', suggestedSellingPrice: '', suggestedSellingPriceCurrency: 'USD', minStockAlert: '', category: 'General' });
                setCurrentInventoryPage(1); // Reset to first page after adding/updating
            };

            // Manejador para cargar un item de inventario para edición
            const handleEditInventoryItem = (item) => {
                setNewInventoryItem({
                    name: item.name,
                    stockQuantity: item.stockQuantity,
                    stockUnitType: item.stockUnitType,
                    totalCostPurchase: item.totalCostPurchase,
                    totalCostPurchaseCurrency: item.totalCostPurchaseCurrency || 'USD', // Default to USD for old data
                    suggestedSellingPrice: item.suggestedSellingPrice,
                    suggestedSellingPriceCurrency: item.suggestedSellingPriceCurrency || 'USD', // Default to USD for old data
                    minStockAlert: item.minStockAlert !== undefined ? item.minStockAlert : '',
                    category: item.category || 'General',
                });
                setEditingInventoryItem(item.id);
            };

            // Manejador para eliminar un item del inventario
            const handleDeleteInventoryItem = (id) => {
                openConfirmModal(
                    '¿Estás seguro de que quieres eliminar este producto del inventario?',
                    () => {
                        setInventory(prevInventory => prevInventory.filter(item => item.id !== id));
                        showMessage('Producto de inventario eliminado.', 'success');
                        if (paginatedInventory.length === 1 && currentInventoryPage > 1) {
                            setCurrentInventoryPage(currentInventoryPage - 1);
                        }
                    }
                );
            };

            // Manejador para borrar todo el inventario
            const handleClearInventory = () => {
                openConfirmModal(
                    '¿Estás seguro de que quieres borrar TODO el inventario? Esta acción no se puede deshacer.',
                    () => {
                        setInventory([]);
                        localStorage.removeItem('inventory');
                        showMessage('Inventario borrado.', 'success');
                        setCurrentInventoryPage(1);
                    }
                );
            };


            // Función de ayuda para convertir a USD
            const convertToUSD = useCallback((amount, currency) => {
                if (currency === 'VES') {
                    return exchangeRate > 0 ? amount / exchangeRate : 0;
                }
                return amount;
            }, [exchangeRate]);

            // Cálculos de totales y ganancia/pérdida
            const totalSalesUSD = sales.reduce((acc, sale) => {
                const saleTotalUSD = (sale.items || []).reduce((itemAcc, item) => { // Added defensive check
                    const effectiveAmount = item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount;
                    return itemAcc + convertToUSD(effectiveAmount, item.currency);
                }, 0);
                return acc + saleTotalUSD;
            }, 0);
            const totalSalesVES = totalSalesUSD * exchangeRate; // Calcular VES a partir de USD total

            const totalExpensesUSD = expenses.reduce((acc, expense) => acc + convertToUSD(expense.amount, expense.currency), 0);        
            const totalExpensesVES = totalExpensesUSD * exchangeRate; // Calcular VES a partir de USD total
            
            const totalCreditSalesUSD = creditSales.reduce((acc, sale) => acc + sale.totalUSD, 0); // Changed from totalCheeseCreditSalesUSD
            const totalCreditSalesVES = totalCreditSalesUSD * exchangeRate; // Calcular VES a partir de USD total del fiado

            // Calculate total inventory value based on costPerUnit (which is always in USD)
            const totalInventoryValueUSD = inventory.reduce((acc, item) => acc + (item.stockQuantity * item.costPerUnit), 0);
            const totalInventoryValueVES = totalInventoryValueUSD * exchangeRate;


            const netProfitUSD = totalSalesUSD - totalExpensesUSD;
            const netProfitVES = netProfitUSD * exchangeRate;

            // Lógica de ordenación para ventas
            const handleSalesSort = (column) => {
                if (salesSortColumn === column) {
                    setSalesSortDirection(salesSortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSalesSortColumn(column);
                    setSalesSortDirection('asc');
                }
                setCurrentSalesPage(1); // Reset to first page on sort change
            };

            // Lógica de ordenación para gastos
            const handleExpensesSort = (column) => {
                if (expensesSortColumn === column) {
                    setExpensesSortDirection(expensesSortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setExpensesSortColumn(column);
                    setExpensesSortDirection('asc');
                }
                setCurrentExpensesPage(1); // Reset to first page on sort change
            };
            
            // Lógica de ordenación para ventas a crédito (generalizado)
            const handleCreditSalesSort = (column) => {
                if (creditSalesSortColumn === column) {
                    setCreditSalesSortDirection(creditSalesSortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setCreditSalesSortColumn(column);
                    setCreditSalesSortDirection('asc');
                }
                setCurrentCreditSalesPage(1);
            };

            // Lógica de ordenación para inventario
            const handleInventorySort = (column) => {
                if (inventorySortColumn === column) {
                    setInventorySortDirection(inventorySortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setInventorySortColumn(column);
                    setInventorySortDirection('asc');
                }
                setCurrentInventoryPage(1); // Reset to first page on sort change
            };


            // Memoized filtered and sorted sales data
            const filteredAndSortedSales = useMemo(() => {
                let tempSales = [...sales];

                // Filter by search term
                if (salesSearchTerm) {
                    tempSales = tempSales.filter(sale =>
                        sale.paymentMethod.toLowerCase().includes(salesSearchTerm.toLowerCase()) ||
                        sale.operationNumber.toLowerCase().includes(salesSearchTerm.toLowerCase()) ||
                        (sale.items || []).some(item => item.product.toLowerCase().includes(salesSearchTerm.toLowerCase()))
                    );
                }

                // Filter by date range
                if (salesStartDate) {
                    tempSales = tempSales.filter(sale => sale.date >= salesStartDate);
                }
                if (salesEndDate) {
                    tempSales = tempSales.filter(sale => sale.date <= salesEndDate);
                }

                // Sort
                tempSales.sort((a, b) => {
                    let aValue, bValue;

                    switch (salesSortColumn) {
                        case 'date':
                            aValue = new Date(a.date);
                            bValue = new Date(b.date);
                            break;
                        case 'product':
                            aValue = (a.items && (a.items || []).length > 0 && (a.items || [])[0].product) ? (a.items || [])[0].product.toLowerCase() : '';
                            bValue = (b.items && (b.items || []).length > 0 && (b.items || [])[0].product) ? (b.items || [])[0].product.toLowerCase() : '';
                            break;
                        case 'totalAmount':
                            let aTotal = (a.items || []).reduce((acc, item) => {
                                const effectiveAmount = item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount;
                                return acc + convertToUSD(effectiveAmount, item.currency);
                            }, 0);
                            let bTotal = (b.items || []).reduce((acc, item) => {
                                const effectiveAmount = item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount;
                                return acc + convertToUSD(effectiveAmount, item.currency);
                            }, 0);
                            aValue = aTotal;
                            bValue = bTotal;
                            break;
                        default:
                            return 0;
                    }

                    if (aValue < bValue) return salesSortDirection === 'asc' ? -1 : 1;
                    if (aValue > bValue) return salesSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                return tempSales;
            }, [sales, salesSearchTerm, salesStartDate, salesEndDate, salesSortColumn, salesSortDirection, convertToUSD]);

            // Paginación de ventas
            const totalSalesPages = Math.ceil(filteredAndSortedSales.length / ITEMS_PER_PAGE);
            const paginatedSales = useMemo(() => {
                const startIndex = (currentSalesPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                return filteredAndSortedSales.slice(startIndex, endIndex);
            }, [filteredAndSortedSales, currentSalesPage]);


            // Memoized filtered and sorted expenses data
            const filteredAndSortedExpenses = useMemo(() => {
                let tempExpenses = [...expenses];

                // Filter by search term
                if (expensesSearchTerm) {
                    tempExpenses = tempExpenses.filter(expense =>
                        expense.category.toLowerCase().includes(expensesSearchTerm.toLowerCase())
                    );
                }

                // Filter by date range
                if (expensesStartDate) {
                    tempExpenses = tempExpenses.filter(expense => expense.date >= expensesStartDate);
                }
                if (expensesEndDate) {
                    tempExpenses = tempExpenses.filter(expense => expense.date <= expensesEndDate);
                }

                // Sort
                tempExpenses.sort((a, b) => {
                    let aValue, bValue;

                    switch (expensesSortColumn) {
                        case 'date':
                            aValue = new Date(a.date);
                            bValue = new Date(b.date);
                            break;
                        case 'category':
                            aValue = a.category.toLowerCase();
                            bValue = b.category.toLowerCase();
                            break;
                        case 'amount':
                            aValue = parseFloat(convertToUSD(a.amount, a.currency));
                            bValue = parseFloat(convertToUSD(b.amount, b.currency));
                            break;
                        default:
                            return 0;
                    }

                    if (aValue < bValue) return expensesSortDirection === 'asc' ? -1 : 1;
                    if (aValue > bValue) return expensesSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                return tempExpenses;
            }, [expenses, expensesSearchTerm, expensesStartDate, expensesEndDate, expensesSortColumn, expensesSortDirection, convertToUSD]);

            // Paginación de gastos
            const totalExpensesPages = Math.ceil(filteredAndSortedExpenses.length / ITEMS_PER_PAGE);
            const paginatedExpenses = useMemo(() => {
                const startIndex = (currentExpensesPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                return filteredAndSortedExpenses.slice(startIndex, endIndex);
            }, [filteredAndSortedExpenses, currentExpensesPage]);
            
            // Memoized filtered and sorted credit sales data (generalizado)
            const filteredAndSortedCreditSales = useMemo(() => {
                let tempCreditSales = [...creditSales];

                // Filter by search term (customer name or product name)
                if (creditSalesSearchTerm) {
                    tempCreditSales = tempCreditSales.filter(sale =>
                        sale.customerName.toLowerCase().includes(creditSalesSearchTerm.toLowerCase()) ||
                        sale.productName.toLowerCase().includes(creditSalesSearchTerm.toLowerCase())
                    );
                }

                // Filter by status
                if (creditSalesStatusFilter !== 'Todos') {
                    tempCreditSales = tempCreditSales.filter(sale => sale.status === creditSalesStatusFilter);
                }

                // Sort
                tempCreditSales.sort((a, b) => {
                    let aValue, bValue;

                    switch (creditSalesSortColumn) {
                        case 'date':
                            aValue = new Date(a.date);
                            bValue = new Date(b.date);
                            break;
                        case 'customerName':
                            aValue = a.customerName.toLowerCase();
                            bValue = b.customerName.toLowerCase();
                            break;
                        case 'totalUSD':
                            aValue = a.totalUSD;
                            bValue = b.totalUSD;
                            break;
                        case 'productName': // Added sort by product name
                            aValue = a.productName.toLowerCase();
                            bValue = b.productName.toLowerCase();
                            break;
                        default:
                            return 0;
                    }

                    if (aValue < bValue) return creditSalesSortDirection === 'asc' ? -1 : 1;
                    if (aValue > bValue) return creditSalesSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                return tempCreditSales;
            }, [creditSales, creditSalesSearchTerm, creditSalesStatusFilter, creditSalesSortColumn, creditSalesSortDirection]);

            // Paginación de ventas a crédito (generalizado)
            const totalCreditSalesPages = Math.ceil(filteredAndSortedCreditSales.length / ITEMS_PER_PAGE);
            const paginatedCreditSales = useMemo(() => {
                const startIndex = (currentCreditSalesPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                return filteredAndSortedCreditSales.slice(startIndex, endIndex);
            }, [filteredAndSortedCreditSales, currentCreditSalesPage]);

            // Memoized filtered and sorted inventory data
            const filteredAndSortedInventory = useMemo(() => {
                let tempInventory = [...inventory];

                // Filter by search term (product name)
                if (inventorySearchTerm) {
                    tempInventory = tempInventory.filter(item =>
                        item.name.toLowerCase().includes(inventorySearchTerm.toLowerCase())
                    );
                }

                // Filter by category
                if (inventoryCategoryFilter !== 'Todas') {
                    tempInventory = tempInventory.filter(item => item.category === inventoryCategoryFilter);
                }

                // Sort
                tempInventory.sort((a, b) => {
                    let aValue, bValue;

                    switch (inventorySortColumn) {
                        case 'name':
                            aValue = a.name.toLowerCase();
                            bValue = b.name.toLowerCase();
                            break;
                        case 'stockQuantity':
                            aValue = a.stockQuantity;
                            bValue = b.stockQuantity;
                            break;
                        case 'costPerUnit':
                            aValue = a.costPerUnit; // Already in USD
                            bValue = b.costPerUnit; // Already in USD
                            break;
                        case 'lastUpdated':
                            aValue = new Date(a.lastUpdated);
                            bValue = new Date(b.lastUpdated);
                            break;
                        case 'suggestedSellingPrice':
                            // Sort by suggested selling price converted to USD
                            aValue = convertToUSDFromAny(a.suggestedSellingPrice, a.suggestedSellingPriceCurrency);
                            bValue = convertToUSDFromAny(b.suggestedSellingPrice, b.suggestedSellingPriceCurrency);
                            break;
                        default:
                            return 0;
                    }

                    if (aValue < bValue) return inventorySortDirection === 'asc' ? -1 : 1;
                    if (aValue > bValue) return inventorySortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                return tempInventory;
            }, [inventory, inventorySearchTerm, inventoryCategoryFilter, inventorySortColumn, inventorySortDirection, convertToUSDFromAny]);

            // Paginación de inventario
            const totalInventoryPages = Math.ceil(filteredAndSortedInventory.length / ITEMS_PER_PAGE);
            const paginatedInventory = useMemo(() => {
                const startIndex = (currentInventoryPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                return filteredAndSortedInventory.slice(startIndex, endIndex);
            }, [filteredAndSortedInventory, currentInventoryPage]);

            // Get unique inventory categories for filter dropdown
            const uniqueInventoryCategories = useMemo(() => {
                const categories = new Set(inventory.map(item => item.category));
                return ['Todas', ...Array.from(categories).sort()];
            }, [inventory]);


            // Helper function to export data to CSV
            const exportToCSV = (data, filename, headers) => {
                if (!data || data.length === 0) {
                    showMessage('No hay datos para exportar.', 'info');
                    return;
                }

                let csvContent = '';

                // Add headers
                if (headers) {
                    csvContent += headers.join(',') + '\n';
                } else {
                    // If no specific headers, use keys from the first object
                    csvContent += Object.keys(data[0]).join(',') + '\n';
                }

                // Add data rows
                data.forEach(row => {
                    const values = headers ? headers.map(header => {
                        // Handle nested objects for sales items
                        if (header === 'items' && Array.isArray(row[header])) {
                            return `"${row[header].map(item => `${item.product} (${item.quantity} ${item.unitType})`).join('; ')}"`
                        }
                        // Handle currency conversion for amounts in expenses and inventory
                        if (header === 'amount' && row.currency) {
                            return `${row.amount} ${row.currency}`;
                        }
                        if (header === 'totalCostPurchase' && row.totalCostPurchaseCurrency) {
                            return `${row.totalCostPurchase} ${row.totalCostPurchaseCurrency}`;
                        }
                        if (header === 'suggestedSellingPrice' && row.suggestedSellingPriceCurrency) {
                            return `${row.suggestedSellingPrice} ${row.suggestedSellingPriceCurrency}`;
                        }
                        if (header === 'costPerUnit') {
                            return `${row.costPerUnit.toFixed(3)} USD`;
                        }
                        // Specific handling for profitability report
                        if (header === 'profitUSD' || header === 'profitPercentage') {
                            return String(row[header]).replace(/"/g, '""');
                        }
                        // Handle credit sales specific fields
                        if (header === 'quantity' && row.unitType) {
                            return `${row.quantity} ${row.unitType === 'gramos' ? 'g' : row.unitType}`;
                        }
                        if (header === 'amountPerUnit' && row.currencyPerUnit) {
                            return `${row.amountPerUnit} ${row.currencyPerUnit}`;
                        }
                        return `"${String(row[header]).replace(/"/g, '""')}"`;
                    }).join(',') : Object.values(row).map(value => `"${String(value).replace(/"/g, '""')}"`).join(',');
                    csvContent += values + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) { // Feature detection for download attribute
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessage(`Datos exportados a ${filename}`, 'success');
                } else {
                    showMessage('Tu navegador no soporta la descarga de archivos CSV directamente. Copia el texto.', 'warning');
                    console.log(csvContent); // Log to console for manual copy
                }
            };


            // Summaries for reports
            const filteredSalesForReports = useMemo(() => {
                let tempSales = [...sales];
                if (reportStartDate) {
                    tempSales = tempSales.filter(sale => sale.date >= reportStartDate);
                }
                if (reportEndDate) {
                    tempSales = tempSales.filter(sale => sale.date <= reportEndDate);
                }
                return tempSales;
            }, [sales, reportStartDate, reportEndDate]);

            const filteredExpensesForReports = useMemo(() => {
                let tempExpenses = [...expenses];
                if (reportStartDate) {
                    tempExpenses = tempExpenses.filter(expense => expense.date >= reportStartDate);
                }
                if (reportEndDate) {
                    tempExpenses = tempExpenses.filter(expense => expense.date <= reportEndDate);
                }
                return tempExpenses;
            }, [expenses, reportStartDate, reportEndDate]);


            const salesSummaryByProduct = useMemo(() => {
                const summary = {};
                filteredSalesForReports.forEach(sale => {
                    (sale.items || []).forEach(item => {
                        const totalAmountUSD = convertToUSD(item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount, item.currency);
                        summary[item.product] = (summary[item.product] || 0) + totalAmountUSD;
                    });
                });
                return Object.entries(summary).sort(([,a],[,b]) => b - a); // Sort descending by amount
            }, [filteredSalesForReports, convertToUSD]);

            const expensesSummaryByCategory = useMemo(() => {
                const summary = {};
                filteredExpensesForReports.forEach(expense => {
                    const amountUSD = convertToUSD(expense.amount, expense.currency);
                    summary[expense.category] = (summary[expense.category] || 0) + amountUSD;
                });
                return Object.entries(summary).sort(([,a],[,b]) => b - a); // Sort descending by amount
            }, [filteredExpensesForReports, convertToUSD]);

            const salesSummaryByPaymentMethod = useMemo(() => {
                const summary = {};
                filteredSalesForReports.forEach(sale => {
                    const totalSaleAmountUSD = (sale.items || []).reduce((acc, item) => {
                        const effectiveAmount = item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount;
                        return acc + convertToUSD(effectiveAmount, item.currency);
                    }, 0);
                    summary[sale.paymentMethod] = (summary[sale.paymentMethod] || 0) + totalSaleAmountUSD;
                });
                return Object.entries(summary).sort(([,a],[,b]) => b - a); // Sort descending by amount
            }, [filteredSalesForReports, convertToUSD]);

            const profitabilityByProduct = useMemo(() => {
                const productSales = {}; // { productName: { totalRevenue: X, totalQuantitySold: Y } }
                const productCosts = {}; // { productName: costPerUnit }

                // Aggregate sales revenue and quantity
                filteredSalesForReports.forEach(sale => {
                    (sale.items || []).forEach(item => {
                        const effectiveAmount = item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount;
                        const revenueUSD = convertToUSD(effectiveAmount, item.currency);
                        const productName = item.product.replace(' (Peso)', ''); // Remove '(Peso)' for matching with inventory

                        if (!productSales[productName]) {
                            productSales[productName] = { totalRevenue: 0, totalQuantitySold: 0 };
                        }
                        productSales[productName].totalRevenue += revenueUSD;
                        productSales[productName].totalQuantitySold += item.quantity;
                    });
                });

                // Get cost per unit from inventory
                inventory.forEach(item => {
                    productCosts[item.name] = item.costPerUnit; // costPerUnit is always in USD
                });

                const profitability = [];
                for (const productName in productSales) {
                    const revenue = productSales[productName].totalRevenue;
                    const quantitySold = productSales[productName].totalQuantitySold;
                    const costPerUnit = productCosts[productName] || 0; // Get cost from inventory

                    const totalCost = costPerUnit * quantitySold;
                    const profitUSD = revenue - totalCost;
                    const profitPercentage = totalCost > 0 ? (profitUSD / totalCost) * 100 : 0;

                    profitability.push({
                        product: productName,
                        totalRevenueUSD: revenue,
                        totalCostUSD: totalCost,
                        profitUSD: profitUSD,
                        profitPercentage: profitPercentage,
                    });
                }

                return profitability.sort((a, b) => b.profitUSD - a.profitUSD); // Sort by profit descending
            }, [filteredSalesForReports, inventory, convertToUSD]);

            // Effect to update creditAmountPerUnit and creditUnitType when creditProductName changes
            useEffect(() => {
                if (!editingCreditSaleId && creditProductName) { // Only auto-fill if not in edit mode
                    const selectedProduct = inventory.find(item => item.name === creditProductName);
                    if (selectedProduct) {
                        setCreditUnitType(selectedProduct.stockUnitType);
                        // Optionally pre-fill amountPerUnit with suggested selling price
                        setCreditAmountPerUnit(selectedProduct.suggestedSellingPrice || '');
                        setCreditCurrencyPerUnit(selectedProduct.suggestedSellingPriceCurrency || 'USD');
                    }
                } else if (!creditProductName && !editingCreditSaleId) {
                    setCreditUnitType('unidades'); // Reset to default if no product selected and not editing
                    setCreditAmountPerUnit('');
                    setCreditCurrencyPerUnit('USD');
                }
            }, [creditProductName, inventory, editingCreditSaleId]);


            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">
                    {/* Mensajes de notificación con botón de cierre */}
                    {showMessageBox && (
                        <MessageBox message={message} type={messageType} onClose={closeMessage} />
                    )}

                    {/* Modal de Confirmación */}
                    {showConfirmModal && (
                        <ConfirmModal
                            message={modalMessage}
                            onConfirm={handleConfirm}
                            onCancel={handleCancel}
                        />
                    )}

                    {/* Modal para Registrar Pago de Crédito */}
                    {payingCreditSaleId && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-2xl font-bold text-gray-800 mb-6">Registrar Pago de Crédito</h3>
                                <form onSubmit={handleRegisterCreditPayment}>
                                    <div className="mb-6">
                                        <label htmlFor="paymentAmount" className="block text-gray-700 text-base font-bold mb-2">Monto a Pagar (USD):</label>
                                        <input
                                            type="number"
                                            id="paymentAmount"
                                            value={paymentAmount}
                                            onChange={(e) => setPaymentAmount(e.target.value)}
                                            className="w-full"
                                            placeholder="Ej: 5.00"
                                            min="0.01"
                                            step="0.01"
                                            required
                                        />
                                    </div>
                                    <div className="flex justify-center space-x-8">
                                        <button
                                            type="button"
                                            onClick={() => { setPayingCreditSaleId(null); setPaymentAmount(''); }}
                                            className="px-9 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50 text-xl font-medium"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            type="submit"
                                            className="px-9 py-4 bg-blue-400 text-white rounded-xl hover:bg-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-50 text-xl font-medium"
                                        >
                                            Registrar Pago
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}


                    <div className="w-full max-w-6xl bg-white main-container mb-8">
                        <h1 className="main-heading text-center mb-14">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-dollar-sign">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Gestor de Ventas y Presupuesto
                        </h1>

                        {/* Sección de Tasa de Cambio */}
                        <div className="mb-16 p-9 bg-blue-50 border border-blue-100 rounded-3xl shadow-lg">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrows-right-left text-blue-800">
                                    <path d="M8 3H18L22 7L18 11H8"></path>
                                    <path d="M16 21H6L2 17L6 13H16"></path>
                                </svg>
                                Tasa de Cambio (USD a VES)
                                </span>
                            </h2>
                            <div className="flex flex-col sm:flex-row items-center space-y-6 sm:space-y-0 sm:space-x-6">
                                <label htmlFor="exchangeRate" className="text-xl text-gray-700 font-medium">1 USD =</label>
                                <input
                                    type="number"
                                    id="exchangeRate"
                                    value={exchangeRate}
                                    onChange={(e) => setExchangeRate(parseFloat(e.target.value) || 0)}
                                    className="flex-grow max-w-xs px-6 py-3.5 border border-blue-200 rounded-xl focus:ring-blue-400 focus:border-blue-400 text-lg"
                                    placeholder="Ej: 36.5"
                                    step="0.01"
                                    min="0"
                                />
                                <span className="text-xl text-gray-700 font-medium">VES</span>
                            </div>
                            <p className="text-sm text-gray-700 mt-6 text-center">
                                Actualiza este valor diariamente con la tasa de cambio actual (ej. BCV).
                            </p>
                            <p className="text-base text-blue-800 mt-3 text-center font-semibold">
                                ✨ Tus datos (ventas, gastos, tasa e inventario) se guardan automáticamente en tu navegador.
                            </p>
                        </div>

                        {/* Resumen General */}
                        <div className="mb-16">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-pie-chart text-gray-600">
                                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                                    <path d="M22 12A10 10 0 0 0 12 2v10Z"></path>
                                </svg>
                                Resumen General
                                </span>
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-9">
                                {/* Total Ventas */}
                                <div className="bg-gradient-to-br from-emerald-300 to-emerald-500 text-white p-9 rounded-3xl shadow-2xl flex flex-col items-center justify-center transform hover:scale-105 transition duration-300">
                                    <h3 className="sub-heading mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.8" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trending-up">
                                            <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                                            <polyline points="16 7 22 7 22 13"></polyline>
                                        </svg>
                                        Total Ventas (USD)
                                    </h3>
                                    <p className="card-value">
                                        <span className="card-currency">$</span>{totalSalesUSD.toFixed(2)}
                                    </p>
                                    <p className="card-secondary-value mt-4">
                                        ≈ Bs. {(totalSalesUSD * exchangeRate).toFixed(2)} VES
                                    </p>
                                </div>
                                {/* Total Gastos */}
                                <div className="bg-gradient-to-br from-rose-300 to-rose-500 text-white p-9 rounded-3xl shadow-2xl flex flex-col items-center justify-center transform hover:scale-105 transition duration-300">
                                    <h3 className="sub-heading mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.8" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trending-down">
                                            <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline>
                                            <polyline points="16 17 22 17 22 11"></polyline>
                                        </svg>
                                        Total Gastos (USD)
                                    </h3>
                                    <p className="card-value">
                                        <span className="card-currency">$</span>{totalExpensesUSD.toFixed(2)}
                                    </p>
                                    <p className="card-secondary-value mt-4">
                                        ≈ Bs. {(totalExpensesUSD * exchangeRate).toFixed(2)} VES
                                    </p>
                                </div>
                                {/* Ganancia Neta */}
                                <div className="bg-gradient-to-br from-violet-400 to-indigo-600 text-white p-9 rounded-3xl shadow-2xl flex flex-col items-center justify-center transform hover:scale-105 transition duration-300">
                                    <h3 className="sub-heading mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.8" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-sack">
                                            <path d="M12 10h.01"></path>
                                            <path d="M17 10h.01"></path>
                                            <path d="M7 10h.01"></path>
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8Z"></path>
                                            <path d="M18 8h-4"></path>
                                            <path d="M10 2v4"></path>
                                            <path d="M8 2h4"></path>
                                            <path d="M10 10v10"></path>
                                            <path d="M14 10v10"></path>
                                        </svg>
                                        Ganancia Neta (USD)
                                    </h3>
                                    <p className="card-value">
                                        <span className="card-currency">$</span>{netProfitUSD.toFixed(2)}
                                    </p>
                                    <p className="card-secondary-value mt-4">
                                        ≈ Bs. {(netProfitUSD * exchangeRate).toFixed(2)} VES
                                    </p>
                                </div>
                                {/* Valor Total en Inventario */}
                                <div className="bg-gradient-to-br from-orange-300 to-orange-500 text-white p-9 rounded-3xl shadow-2xl flex flex-col items-center justify-center transform hover:scale-105 transition duration-300">
                                    <h3 className="sub-heading mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.8" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-boxes">
                                            <path d="M2.97 12.93a2 2 0 0 0 0 3.14l1.97 2.63c.41.55 1.05.82 1.69.82h10.72c.64 0 1.28-.27 1.69-.82l1.97-2.63a2 2 0 0 0 0-3.14l-1.97-2.63c-.41-.55-1.05-.82-1.69-.82H6.66c-.64 0-1.28.27-1.69.82Z"></path>
                                            <path d="M7.5 14.5h9"></path>
                                            <path d="M12 2v2"></path>
                                            <path d="M12 22v-2"></path>
                                            <path d="M16 4h2"></path>
                                            <path d="M6 4H8"></path>
                                            <path d="M16 20h2"></path>
                                            <path d="M6 20H8"></path>
                                            <path d="M2 12h2"></path>
                                            <path d="M20 12h2"></path>
                                        </svg>
                                        Valor Total en Inventario (USD)
                                    </h3>
                                    <p className="card-value">
                                        <span className="card-currency">$</span>{totalInventoryValueUSD.toFixed(2)}
                                    </p>
                                    <p className="card-secondary-value mt-4">
                                        ≈ Bs. {(totalInventoryValueVES).toFixed(2)} VES
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Formulario de Nueva Venta */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-plus-circle text-blue-600">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="16"></line>
                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                </svg>
                                Registrar Nueva Venta
                                </span>
                            </h2>
                            <form onSubmit={handleAddSale} className="grid grid-cols-1 gap-8">
                                <div className="md:col-span-2">
                                    <label className="block text-gray-700 text-base font-bold mb-2">Tipo de Venta para nuevos productos (si no seleccionas del inventario):</label>
                                    <div className="flex space-x-4">
                                        <label className="inline-flex items-center">
                                            <input
                                                type="radio"
                                                className="form-radio text-blue-600"
                                                name="saleType"
                                                value="unidades"
                                                checked={saleTypeForSale === 'unidades'}
                                                onChange={() => setSaleTypeForSale('unidades')}
                                            />
                                            <span className="ml-2 text-gray-700 text-lg">Por Unidades</span>
                                        </label>
                                        <label className="inline-flex items-center">
                                            <input
                                                type="radio"
                                                className="form-radio text-blue-600"
                                                name="saleType"
                                                value="peso"
                                                checked={saleTypeForSale === 'peso'}
                                                onChange={() => setSaleTypeForSale('peso')}
                                            />
                                            <span className="ml-2 text-gray-700 text-lg">Por Peso (Gramos/Kilo)</span>
                                        </label>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2">Esta opción establece el tipo predeterminado para las nuevas líneas de productos que no vienen del inventario.</p>
                                </div>

                                <div>
                                    <label htmlFor="saleDate" className="block text-gray-700 text-base font-bold mb-2">Fecha</label>
                                    <input
                                        type="date"
                                        id="saleDate"
                                        value={saleDate}
                                        onChange={(e) => setSaleDate(e.target.value)}
                                        className="w-full"
                                        required
                                    />
                                </div>
                                <div className="col-span-1">
                                    <label htmlFor="salePaymentMethod" className="block text-gray-700 text-base font-bold mb-2">Método de Pago</label>
                                    <select
                                        id="salePaymentMethod"
                                        value={salePaymentMethod}
                                        onChange={(e) => {
                                            setSalePaymentMethod(e.target.value);
                                            if (e.target.value !== 'Pago Móvil') {
                                                setSaleOperationNumber('');        
                                            }
                                        }}
                                        className="w-full"
                                        required
                                    >
                                        <option value="">Seleccione</option>
                                        <option value="Efectivo USD">Efectivo USD</option>
                                        <option value="Efectivo VES">Efectivo VES</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Pago Móvil">Pago Móvil</option>
                                    </select>
                                </div>
                                {salePaymentMethod === 'Pago Móvil' && (
                                    <div className="col-span-1">
                                        <label htmlFor="saleOperationNumber" className="block text-gray-700 text-base font-bold mb-2">Número de Operación</label>
                                        <input
                                            type="text"
                                            id="saleOperationNumber"
                                            value={saleOperationNumber}
                                            onChange={(e) => setSaleOperationNumber(e.target.value)}
                                            className="w-full"
                                            placeholder="Número de operación (Pago Móvil)"
                                            required={salePaymentMethod === 'Pago Móvil'}
                                        />
                                    </div>
                                )}

                                {/* Dynamic product entry */}
                                <div className="md:col-span-2 mt-4 border p-4 rounded-xl bg-gray-50">
                                    <h3 className="text-lg font-bold text-gray-800 mb-4">Productos en esta Venta:</h3>
                                    {saleItems.map((item, index) => (
                                        <div key={index} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 items-end p-3 border-b border-gray-200 last:mb-0 last:border-b-0">
                                            <div className="sm:col-span-2 lg:col-span-1">
                                                <label htmlFor={`product-${index}`} className="block text-gray-700 text-sm font-bold mb-1">Producto</label>
                                                <select
                                                    id={`product-${index}`}
                                                    value={item.product}
                                                    onChange={(e) => handleSaleItemChange(index, 'product', e.target.value)}
                                                    className="w-full"
                                                    required
                                                >
                                                    <option value="">Seleccione un producto</option>
                                                    {inventory.map(invItem => (
                                                        <option key={invItem.id} value={invItem.name}>
                                                            {invItem.name} ({invItem.stockUnitType === 'unidades' ? 'unidades' : 'gramos'})
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label htmlFor={`quantity-${index}`} className="block text-gray-700 text-sm font-bold mb-1">
                                                    Cantidad {item.unitType === 'peso_g' ? '(Gramos)' : ''}
                                                </label>
                                                <input
                                                    type="number"
                                                    id={`quantity-${index}`}
                                                    value={item.quantity}
                                                    onChange={(e) => handleSaleItemChange(index, 'quantity', e.target.value)}
                                                    className="w-full"
                                                    placeholder={item.unitType === 'peso_g' ? "Peso en gramos" : "Cantidad"}
                                                    min="0.01"
                                                    step="0.01"
                                                    required
                                                />
                                            </div>
                                            <div className="flex items-end space-x-2">
                                                <div className="flex-grow">
                                                    <label htmlFor={`amount-${index}`} className="block text-gray-700 text-sm font-bold mb-1">
                                                        Monto {item.unitType === 'peso_g' ? '(USD/Kilo)' : '(Unitario)'}
                                                    </label>
                                                    <input
                                                        type="number"
                                                        id={`amount-${index}`}
                                                        value={item.amount}
                                                        onChange={(e) => handleSaleItemChange(index, 'amount', e.target.value)}
                                                        className="w-full"
                                                        placeholder={item.unitType === 'peso_g' ? "Precio/kilo (USD)" : "Monto unitario"}
                                                        min="0.01"
                                                        step="0.01"
                                                        required
                                                    />
                                                </div>
                                                <div className="flex-shrink-0">
                                                    <label htmlFor={`currency-${index}`} className="sr-only">Moneda</label>
                                                    <select
                                                        id={`currency-${index}`}
                                                        value={item.currency}
                                                        onChange={(e) => handleSaleItemChange(index, 'currency', e.target.value)}
                                                        className="w-full py-3.5"
                                                        // If unitType is 'peso_g', currency must be USD
                                                        disabled={item.unitType === 'peso_g'}
                                                    >
                                                        <option value="USD">USD</option>
                                                        <option value="VES">VES</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label htmlFor={`unitType-${index}`} className="sr-only">Tipo de Unidad</label>
                                                <select
                                                    id={`unitType-${index}`}
                                                    value={item.unitType}
                                                    onChange={(e) => handleSaleItemChange(index, 'unitType', e.target.value)}
                                                    className="w-full py-3.5"
                                                    disabled // Disable as it's now controlled by inventory selection
                                                >
                                                    <option value="unidades">Unidades</option>
                                                    <option value="peso_g">Gramos</option>
                                                </select>
                                            </div>
                                            {saleItems.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => handleRemoveSaleItem(index)}
                                                    className="bg-rose-500 text-white py-3 px-4 rounded-xl hover:bg-rose-600 focus:outline-none focus:ring-4 focus:ring-rose-300 focus:ring-opacity-50 text-base"
                                                >
                                                    Eliminar Producto
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button
                                        type="button"
                                        onClick={handleAddSaleItem}
                                        className="mt-4 w-full bg-emerald-400 text-white py-3.5 px-8 rounded-xl hover:bg-emerald-500 focus:outline-none focus:ring-4 focus:ring-emerald-300 focus:ring-opacity-50 text-lg flex items-center justify-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-plus mr-2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Agregar Otro Producto
                                    </button>
                                </div>

                                <div className="md:col-span-2 mt-5">
                                    <button
                                        type="submit"
                                        className="w-full bg-blue-400 text-white py-4.5 px-8 rounded-xl hover:bg-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-plus mr-3">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Registrar Venta Completa
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Historial de Ventas */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                           <h2 className="section-heading">
                                <span className="section-heading-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-receipt text-gray-600">
                                        <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2h-2h-2h-2h-2h-2h-2H4Z"></path>
                                        <path d="M18 6H8"></path>
                                        <path d="M18 10H8"></path>
                                        <path d="M18 14H8"></path>
                                        <path d="M18 18H8"></path>
                                    </svg>
                                    Historial de Ventas
                                </span>
                                {sales.length > 0 && (
                                    <button onClick={handleClearSales} className="text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">
                                        Borrar Historial
                                    </button>
                                )}
                            </h2>
                            {/* Sales Filters */}
                            <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label htmlFor="salesSearch" className="block text-gray-700 text-sm font-bold mb-1">Buscar:</label>
                                    <input
                                        type="text"
                                        id="salesSearch"
                                        value={salesSearchTerm}
                                        onChange={(e) => setSalesSearchTerm(e.target.value)}
                                        placeholder="Producto, método de pago, N° operación"
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="salesStartDate" className="block text-gray-700 text-sm font-bold mb-1">Fecha Inicio:</label>
                                    <input
                                        type="date"
                                        id="salesStartDate"
                                        value={salesStartDate}
                                        onChange={(e) => setSalesStartDate(e.target.value)}
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="salesEndDate" className="block text-gray-700 text-sm font-bold mb-1">Fecha Fin:</label>
                                    <input
                                        type="date"
                                        id="salesEndDate"
                                        value={salesEndDate}
                                        onChange={(e) => setSalesEndDate(e.target.value)}
                                        className="w-full text-base"
                                    />
                                </div>
                            </div>
                            {paginatedSales.length === 0 ? (
                                <p className="text-gray-600 text-center py-7 text-lg">No hay ventas registradas que coincidan con los filtros.</p>
                            ) : (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th onClick={() => handleSalesSort('date')}>
                                                        Fecha {salesSortColumn === 'date' && (salesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Productos (Cant.)</th>
                                                    <th onClick={() => handleSalesSort('totalAmount')}>
                                                        Monto Total {salesSortColumn === 'totalAmount' && (salesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Método Pago</th>
                                                    <th>N° Operación</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paginatedSales.map((sale) => (
                                                    <tr key={sale.id}>
                                                        <td>{sale.date}</td>
                                                        <td>
                                                            {(sale.items || []).map((item, itemIndex) => (
                                                                <div key={itemIndex} className="mb-1 last:mb-0">
                                                                    {item.product} ({item.quantity} {item.unitType === 'peso_g' ? 'g' : ''})
                                                                </div>
                                                            ))}
                                                        </td>
                                                        <td>
                                                            {(() => {
                                                                let currentSaleTotalUSD = 0;
                                                                (sale.items || []).forEach(item => {    
                                                                    const effectiveAmount = item.unitType === 'peso_g' ? (item.quantity / 1000) * item.amount : item.quantity * item.amount;
                                                                    currentSaleTotalUSD += convertToUSD(effectiveAmount, item.currency);
                                                                });
                                                                const currentSaleTotalVES = currentSaleTotalUSD * exchangeRate;

                                                                return (
                                                                    <>
                                                                        <div className="font-bold">
                                                                            ${currentSaleTotalUSD.toFixed(2)} USD
                                                                            <span className="text-xs text-gray-500 block font-normal">
                                                                                (≈ Bs. {currentSaleTotalVES.toFixed(2)} VES)
                                                                            </span>
                                                                        </div>
                                                                    </>
                                                                );
                                                            })()}
                                                        </td>
                                                        <td>{sale.paymentMethod || 'N/A'}</td>
                                                        <td>{sale.operationNumber || '-'}</td>
                                                        <td className="text-right">
                                                            <button
                                                                onClick={() => openConfirmModal('¿Estás seguro de que quieres eliminar esta venta?', () => handleDeleteSale(sale.id))}
                                                                className="text-rose-600 hover:text-rose-800 p-2 text-xs"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex justify-between items-center mt-6">
                                        {filteredAndSortedSales.length > 0 && (
                                            <button
                                                onClick={() => exportToCSV(filteredAndSortedSales, 'ventas.csv', ['id', 'date', 'items', 'paymentMethod', 'operationNumber'])}
                                                className="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm"
                                            >
                                                Exportar a CSV
                                            </button>
                                        )}
                                        {filteredAndSortedSales.length > ITEMS_PER_PAGE && (
                                            <div className="pagination-container">
                                                <button
                                                    onClick={() => setCurrentSalesPage(prev => Math.max(prev - 1, 1))}
                                                    disabled={currentSalesPage === 1}
                                                    className="pagination-button"
                                                >
                                                    Anterior
                                                </button>
                                                {Array.from({ length: totalSalesPages }, (_, i) => i + 1).map(page => (
                                                    <button
                                                        key={page}
                                                        onClick={() => setCurrentSalesPage(page)}
                                                        className={`pagination-button ${currentSalesPage === page ? 'active' : ''}`}
                                                    >
                                                        {page}
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setCurrentSalesPage(prev => Math.min(prev + 1, totalSalesPages))}
                                                    disabled={currentSalesPage === totalSalesPages}
                                                    className="pagination-button"
                                                >
                                                    Siguiente
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Formulario de Nuevo Gasto */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                           <h2 className="section-heading">
                                <span className="section-heading-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-minus-circle text-rose-600">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                    </svg>
                                    Registrar Nuevo Gasto
                                </span>
                            </h2>
                            <form onSubmit={handleAddExpense} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label htmlFor="expenseDate" className="block text-gray-700 text-base font-bold mb-2">Fecha</label>
                                    <input
                                        type="date"
                                        id="expenseDate"
                                        value={expenseDate}
                                        onChange={(e) => setExpenseDate(e.target.value)}
                                        className="w-full"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="expenseCategory" className="block text-gray-700 text-base font-bold mb-2">Categoría</label>
                                    <input
                                        type="text"
                                        id="expenseCategory"
                                        value={expenseCategory}
                                        onChange={(e) => setExpenseCategory(e.target.value)}
                                        className="w-full"
                                        placeholder="Ej: Alquiler, Transporte, Publicidad"
                                        required
                                    />
                                </div>
                                <div className="flex items-end space-x-4">
                                    <div className="flex-grow">
                                        <label htmlFor="expenseAmount" className="block text-gray-700 text-base font-bold mb-2">Monto</label>
                                        <input
                                            type="number"
                                            id="expenseAmount"
                                            value={expenseAmount}
                                            onChange={(e) => setExpenseAmount(e.target.value)}    
                                            className="w-full"
                                            placeholder="Monto del gasto"
                                            min="0.01"
                                            step="0.01"
                                            required
                                        />
                                    </div>
                                    <div className="flex-shrink-0">
                                        <label htmlFor="expenseCurrency" className="sr-only">Moneda</label>
                                        <select
                                            id="expenseCurrency"
                                            value={expenseCurrency}
                                            onChange={(e) => setExpenseCurrency(e.target.value)}
                                            className="w-full py-3.5"
                                        >
                                            <option value="USD">USD</option>
                                            <option value="VES">VES</option> {/* Added VES option */}
                                        </select>
                                    </div>
                                </div>
                                <div className="md:col-span-2 mt-5">
                                    <button
                                        type="submit"
                                        className="w-full bg-rose-400 text-white py-4.5 px-8 rounded-xl hover:bg-rose-500 focus:outline-none focus:ring-4 focus:ring-rose-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-minus mr-3">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Agregar Gasto
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Historial de Gastos */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-archive text-gray-600">
                                        <rect width="20" height="5" x="2" y="3" rx="1"></rect>
                                        <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
                                        <path d="M10 12h4"></path>
                                    </svg>
                                    Historial de Gastos
                                </span>
                                {expenses.length > 0 && (
                                    <button onClick={handleClearExpenses} className="text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">
                                        Borrar Historial
                                    </button>
                                )}
                            </h2>
                            {/* Expenses Filters */}
                            <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label htmlFor="expensesSearch" className="block text-gray-700 text-sm font-bold mb-1">Buscar:</label>
                                    <input
                                        type="text"
                                        id="expensesSearch"
                                        value={expensesSearchTerm}
                                        onChange={(e) => setExpensesSearchTerm(e.target.value)}
                                        placeholder="Categoría"
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="expensesStartDate" className="block text-gray-700 text-sm font-bold mb-1">Fecha Inicio:</label>
                                    <input
                                        type="date"
                                        id="expensesStartDate"
                                        value={expensesStartDate}
                                        onChange={(e) => setExpensesStartDate(e.target.value)}
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="expensesEndDate" className="block text-gray-700 text-sm font-bold mb-1">Fecha Fin:</label>
                                    <input
                                        type="date"
                                        id="expensesEndDate"
                                        value={expensesEndDate}
                                        onChange={(e) => setExpensesEndDate(e.target.value)}
                                        className="w-full text-base"
                                    />
                                </div>
                            </div>
                            {paginatedExpenses.length === 0 ? (
                                <p className="text-gray-600 text-center py-7 text-lg">No hay gastos registrados que coincidan con los filtros.</p>
                            ) : (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th onClick={() => handleExpensesSort('date')}>
                                                        Fecha {expensesSortColumn === 'date' && (expensesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleExpensesSort('category')}>
                                                        Categoría {expensesSortColumn === 'category' && (expensesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleExpensesSort('amount')}>
                                                        Monto {expensesSortColumn === 'amount' && (expensesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paginatedExpenses.map((expense) => (
                                                    <tr key={expense.id}>
                                                        <td>{expense.date}</td>
                                                        <td>{expense.category}</td>
                                                        <td>
                                                            {expense.currency === 'USD' ? '$' : 'Bs. '}{expense.amount.toFixed(2)} {expense.currency}
                                                            <span className="text-xs text-gray-500 block font-normal">
                                                                {expense.currency === 'USD' ? ` (≈ ${(expense.amount * exchangeRate).toFixed(2)} VES)` : ` (≈ ${(expense.amount / exchangeRate).toFixed(2)} USD)`}
                                                            </span>
                                                        </td>
                                                        <td className="text-right">
                                                            <button
                                                                onClick={() => openConfirmModal('¿Estás seguro de que quieres eliminar este gasto?', () => handleDeleteExpense(expense.id))}
                                                                className="text-rose-600 hover:text-rose-800 p-2 text-xs"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex justify-between items-center mt-6">
                                        {filteredAndSortedExpenses.length > 0 && (
                                            <button
                                                onClick={() => exportToCSV(filteredAndSortedExpenses, 'gastos.csv', ['id', 'date', 'category', 'amount', 'currency'])}
                                                className="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm"
                                            >
                                                Exportar a CSV
                                            </button>
                                        )}
                                        {filteredAndSortedExpenses.length > ITEMS_PER_PAGE && ( // Solo muestra la paginación si hay más de una página
                                            <div className="pagination-container">
                                                <button
                                                    onClick={() => setCurrentExpensesPage(prev => Math.max(prev - 1, 1))}
                                                    disabled={currentExpensesPage === 1}
                                                    className="pagination-button"
                                                >
                                                    Anterior
                                                </button>
                                                {Array.from({ length: totalExpensesPages }, (_, i) => i + 1).map(page => (
                                                    <button
                                                        key={page}
                                                        onClick={() => setCurrentExpensesPage(page)}
                                                        className={`pagination-button ${currentExpensesPage === page ? 'active' : ''}`}
                                                    >
                                                        {page}
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setCurrentExpensesPage(prev => Math.min(prev + 1, totalExpensesPages))}
                                                    disabled={currentExpensesPage === totalExpensesPages}
                                                    className="pagination-button"
                                                >
                                                    Siguiente
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Calculadora de Venta de Productos (General) */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-calculator text-purple-600">
                                    <rect x="8" y="2" width="8" height="4" rx="1"></rect>
                                    <path d="M17 17v-2H7v2"></path>
                                    <path d="M17 10h-2V7H7v3"></path>
                                    <path d="M14 17h-4V14h4v3Z"></path>
                                    <rect x="3" y="6" width="18" height="16" rx="2"></rect>
                                </svg>
                                Calculadora de Precios de Productos
                                </span>
                            </h2>
                            <div className="flex flex-col sm:flex-row gap-4 mb-8">
                                <button
                                    onClick={() => {
                                        setCalculatorMode('calculateSellingPrice');
                                        // Clear inputs related to the other mode
                                        setDesiredSellingPriceInput('');
                                        setDesiredSellingPriceCurrency('USD');
                                        setCalculatedProfitPercentageResult(null);
                                    }}
                                    className={`flex-grow calculator-mode-button ${calculatorMode === 'calculateSellingPrice' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-dollar-sign">
                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                    </svg>
                                    Calcular Precio de Venta
                                </button>
                                <button
                                    onClick={() => {
                                        setCalculatorMode('calculateProfitPercentage');
                                        // Clear inputs related to the other mode
                                        setProfitPercentage('');
                                        setCalculatedSellingPricePerUnit(null);
                                    }}
                                    className={`flex-grow calculator-mode-button ${calculatorMode === 'calculateProfitPercentage' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-percent">
                                        <line x1="19" y1="5" x2="5" y2="19"></line>
                                        <circle cx="6.5" cy="6.5" r="2.5"></circle>
                                        <circle cx="17.5" cy="17.5" r="2.5"></circle>
                                    </svg>
                                    Calcular % Ganancia
                                </button>
                            </div>

                            {calculatorMode === 'calculateSellingPrice' && (
                                <form onSubmit={handleCalculateSellingPrice} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <label htmlFor="totalCostPrice" className="block text-gray-700 text-base font-bold mb-2">Costo Total de Compra (USD):</label>
                                        <input
                                            type="number"
                                            id="totalCostPrice"
                                            value={totalCostPrice}
                                            onChange={(e) => setTotalCostPrice(e.target.value)}
                                            placeholder="Ej: 150.00"
                                            min="0.01"
                                            step="0.01"
                                            className="w-full"
                                            required
                                        />
                                    </div>
                                    <div className="flex items-end space-x-4">
                                        <div className="flex-grow">
                                            <label htmlFor="purchaseQuantity" className="block text-gray-700 text-base font-bold mb-2">Cantidad Comprada:</label>
                                            <input
                                                type="number"
                                                id="purchaseQuantity"
                                                value={purchaseQuantity}
                                                onChange={(e) => setPurchaseQuantity(e.target.value)}
                                                placeholder="Ej: 10"
                                                min="0.01"
                                                step="0.01"
                                                className="w-full"
                                                required
                                            />
                                        </div>
                                        <div className="flex-shrink-0">
                                            <label htmlFor="purchaseMeasurementUnit" className="sr-only">Unidad de Medida</label>
                                            <select
                                                id="purchaseMeasurementUnit"
                                                value={purchaseMeasurementUnit}
                                                onChange={(e) => setPurchaseMeasurementUnit(e.target.value)}
                                                className="w-full py-3.5"
                                            >
                                                <option value="unidades">Unidades</option>
                                                <option value="gramos">Gramos</option>
                                                <option value="kilos">Kilos</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label htmlFor="profitPercentage" className="block text-gray-700 text-base font-bold mb-2">Porcentaje de Ganancia Deseado (%):</label>
                                        <input
                                            type="number"
                                            id="profitPercentage"
                                            value={profitPercentage}
                                            onChange={(e) => setProfitPercentage(e.target.value)}
                                            placeholder="Ej: 30 (para 30%)"
                                            min="0"
                                            step="0.01"
                                            className="w-full"
                                            required
                                        />
                                    </div>
                                    <div className="md:col-span-2 mt-5">
                                        <button
                                            type="submit"
                                            className="w-full bg-purple-500 text-white py-4.5 px-8 rounded-xl hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-calculator mr-3">
                                                <rect x="8" y="2" width="8" height="4" rx="1"></rect>
                                                <path d="M17 17v-2H7v2"></path>
                                                <path d="M17 10h-2V7H7v3"></path>
                                                <path d="M14 17h-4V14h4v3Z"></path>
                                                <rect x="3" y="6" width="18" height="16" rx="2"></rect>
                                            </svg>
                                            Calcular Precios
                                        </button>
                                    </div>
                                </form>
                            )}

                            {calculatorMode === 'calculateProfitPercentage' && (
                                <form onSubmit={handleCalculateProfitPercentage} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <label htmlFor="totalCostPriceProfit" className="block text-gray-700 text-base font-bold mb-2">Costo Total de Compra (USD):</label>
                                        <input
                                            type="number"
                                            id="totalCostPriceProfit"
                                            value={totalCostPrice}
                                            onChange={(e) => setTotalCostPrice(e.target.value)}
                                            placeholder="Ej: 150.00"
                                            min="0.01"
                                            step="0.01"
                                            className="w-full"
                                            required
                                        />
                                    </div>
                                    <div className="flex items-end space-x-4">
                                        <div className="flex-grow">
                                            <label htmlFor="purchaseQuantityProfit" className="block text-gray-700 text-base font-bold mb-2">Cantidad Comprada:</label>
                                            <input
                                                type="number"
                                                id="purchaseQuantityProfit"
                                                value={purchaseQuantity}
                                                onChange={(e) => setPurchaseQuantity(e.target.value)}
                                                placeholder="Ej: 10"
                                                min="0.01"
                                                step="0.01"
                                                className="w-full"
                                                required
                                            />
                                        </div>
                                        <div className="flex-shrink-0">
                                            <label htmlFor="purchaseMeasurementUnitProfit" className="sr-only">Unidad de Medida</label>
                                            <select
                                                id="purchaseMeasurementUnitProfit"
                                                value={purchaseMeasurementUnit}
                                                onChange={(e) => setPurchaseMeasurementUnit(e.target.value)}
                                                className="w-full py-3.5"
                                            >
                                                <option value="unidades">Unidades</option>
                                                <option value="gramos">Gramos</option>
                                                <option value="kilos">Kilos</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="flex items-end space-x-4">
                                        <div className="flex-grow">
                                            <label htmlFor="desiredSellingPriceInput" className="block text-gray-700 text-base font-bold mb-2">Precio de Venta Deseado por Unidad:</label>
                                            <input
                                                type="number"
                                                id="desiredSellingPriceInput"
                                                value={desiredSellingPriceInput}
                                                onChange={(e) => setDesiredSellingPriceInput(e.target.value)}
                                                placeholder="Ej: 18.00"
                                                min="0.01"
                                                step="0.01"
                                                className="w-full"
                                                required
                                            />
                                        </div>
                                        <div className="flex-shrink-0">
                                            <label htmlFor="desiredSellingPriceCurrency" className="sr-only">Moneda</label>
                                            <select
                                                id="desiredSellingPriceCurrency"
                                                value={desiredSellingPriceCurrency}
                                                onChange={(e) => setDesiredSellingPriceCurrency(e.target.value)}
                                                className="w-full py-3.5"
                                            >
                                                <option value="USD">USD</option>
                                                <option value="VES">VES</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="md:col-span-2 mt-5">
                                        <button
                                            type="submit"
                                            className="w-full bg-purple-500 text-white py-4.5 px-8 rounded-xl hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-calculator mr-3">
                                                <rect x="8" y="2" width="8" height="4" rx="1"></rect>
                                                <path d="M17 17v-2H7v2"></path>
                                                <path d="M17 10h-2V7H7v3"></path>
                                                <path d="M14 17h-4V14h4v3Z"></path>
                                                <rect x="3" y="6" width="18" height="16" rx="2"></rect>
                                            </svg>
                                            Calcular Porcentaje
                                        </button>
                                    </div>
                                </form>
                            )}

                            {(calculatedCostPerUnit !== null || calculatedSellingPricePerUnit !== null || calculatedProfitPercentageResult !== null) && (
                                <div className="mt-9 p-7 bg-purple-50 border border-purple-200 rounded-2xl shadow-inner text-center">
                                    <h3 className="text-xl font-semibold text-purple-800 mb-5">Resultados:</h3>
                                    {calculatedCostPerUnit !== null && (
                                        <p className="text-gray-700 text-lg">
                                            Costo por {purchaseMeasurementUnit === 'unidades' ? 'unidad' : purchaseMeasurementUnit === 'gramos' ? 'gramo' : 'kilo'}: <span className="font-bold text-purple-700">${calculatedCostPerUnit.toFixed(2)} USD</span>
                                        </p>
                                    )}
                                    {calculatorMode === 'calculateSellingPrice' && calculatedSellingPricePerUnit !== null && (
                                        <p className="text-gray-700 text-lg mt-3">
                                            Precio de Venta Sugerido por {purchaseMeasurementUnit === 'unidades' ? 'unidad' : purchaseMeasurementUnit === 'gramos' ? 'gramo' : 'kilo'}: <span className="font-bold text-xl text-purple-900">${calculatedSellingPricePerUnit.toFixed(2)} USD</span>
                                            <br />
                                            <span className="text-sm text-gray-500 block">≈ Bs. {(calculatedSellingPricePerUnit * exchangeRate).toFixed(2)} VES</span>
                                        </p>
                                    )}
                                    {calculatorMode === 'calculateProfitPercentage' && calculatedProfitPercentageResult !== null && (
                                        <p className="text-gray-700 text-lg mt-3">
                                            Porcentaje de Ganancia: <span className="font-bold text-xl text-purple-900">{calculatedProfitPercentageResult.toFixed(2)}%</span>
                                        </p>
                                    )}
                                </div>
                            )}
                        </div>


                        {/* Calculadora de Venta de Queso */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                               <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-cheese text-gray-600">
                                    <path d="M12 21s-3-2-6-2-6 2-6 2V3s3 2 6 2 6-2 6-2v18Z"></path>
                                    <path d="M12 21s3-2 6-2 6 2 6 2V3s-3 2-6 2-6-2-6-2"></path>
                                    <path d="M15 13V8h-3v5"></path>
                                    <path d="M12 8v5h3"></path>
                                    <path d="M9 13V8h3v5"></path>
                                    <path d="M9 8v5h3"></path>
                                </svg>
                                Calculadora de Venta de Queso por Peso
                                </span>
                            </h2>
                           <form onSubmit={handleCalculateCheesePrice} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label htmlFor="cheeseWeightGrams" className="block text-gray-700 text-base font-bold mb-2">Peso del Queso (Gramos):</label>
                                    <input
                                        type="number"
                                        id="cheeseWeightGrams"
                                        value={cheeseWeightGrams}
                                        onChange={(e) => setCheeseWeightGrams(e.target.value)}
                                        placeholder="Ej: 860"
                                        min="0.01"
                                        step="0.01"
                                        className="w-full"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="cheesePricePerKiloUSD" className="block text-gray-700 text-base font-bold mb-2">Precio por Kilo (USD):</label>
                                    <input
                                        type="number"
                                        id="cheesePricePerKiloUSD"
                                        value={cheesePricePerKiloUSD}
                                        onChange={(e) => setCheesePricePerKiloUSD(e.target.value)}
                                        placeholder="Ej: 4.00"
                                        min="0.01"
                                        step="0.01"
                                        className="w-full"
                                        required
                                    />
                                </div>
                                <div className="md:col-span-2 mt-5">
                                    <button
                                        type="submit"
                                        className="w-full bg-green-400 text-white py-4.5 px-8 rounded-xl hover:bg-green-500 focus:outline-none focus:ring-4 focus:ring-green-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-calculator mr-3">
                                            <rect x="8" y="2" width="8" height="4" rx="1"></rect>
                                            <path d="M17 17v-2H7v2"></path>
                                            <path d="M17 10h-2V7H7v3"></path>
                                            <path d="M14 17h-4V14h4v3Z"></path>
                                            <rect x="3" y="6" width="18" height="16" rx="2"></rect>
                                        </svg>
                                        Calcular Precio del Queso
                                    </button>
                                </div>
                            </form>
                            {(calculatedCheesePriceUSD !== null && calculatedCheesePriceVES !== null) && (
                                <div className="mt-9 p-7 bg-green-50 border border-green-200 rounded-2xl shadow-inner text-center">
                                    <h3 className="text-xl font-semibold text-green-800 mb-5">Resultados:</h3>
                                    <p className="text-gray-700 text-lg">
                                        Total a Pagar en Divisas: <span className="font-bold text-green-700">${calculatedCheesePriceUSD.toFixed(2)} USD</span>
                                    </p>
                                    <p className="text-gray-700 text-lg mt-3">
                                        Total a Pagar en Bolívares: <span className="font-bold text-xl text-green-900">Bs. {calculatedCheesePriceVES.toFixed(2)} VES</span>
                                    </p>
                                </div>
                            )}
                        </div>
                        
                        {/* Sección: Gestión de Ventas a Crédito (Generalizado) */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-wallet text-gray-600">
                                    <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h12a2 2 0 0 0 2-2v-3"></path>
                                    <path d="M2 20v-3h.01"></path>
                                </svg>
                                Gestión de Ventas a Crédito
                                </span>
                            </h2>
                            <p className="text-gray-700 text-base mb-6">
                                Registra ventas que tus clientes te pagarán después. El stock se deducirá del inventario.
                            </p>
                            <form onSubmit={handleAddOrUpdateCreditSale} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label htmlFor="creditCustomerName" className="block text-gray-700 text-base font-bold mb-2">Nombre del Cliente:</label>
                                    <input
                                        type="text"
                                        id="creditCustomerName"
                                        value={creditCustomerName}
                                        onChange={(e) => setCreditCustomerName(e.target.value)}
                                        placeholder="Ej: Juan Pérez"
                                        className="w-full"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="creditProductName" className="block text-gray-700 text-base font-bold mb-2">Producto:</label>
                                    <select
                                        id="creditProductName"
                                        value={creditProductName}
                                        onChange={(e) => setCreditProductName(e.target.value)}
                                        className="w-full"
                                        required
                                    >
                                        <option value="">Seleccione un producto</option>
                                        {inventory.map(item => (
                                            <option key={item.id} value={item.name}>
                                                {item.name} ({item.stockUnitType === 'unidades' ? 'unidades' : 'gramos'})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="creditQuantity" className="block text-gray-700 text-base font-bold mb-2">
                                        Cantidad {creditUnitType === 'gramos' ? '(Gramos)' : ''}:
                                    </label>
                                    <input
                                        type="number"
                                        id="creditQuantity"
                                        value={creditQuantity}
                                        onChange={(e) => setCreditQuantity(e.target.value)}
                                        placeholder={creditUnitType === 'gramos' ? "Peso en gramos" : "Cantidad"}
                                        min="0.01"
                                        step="0.01"
                                        className="w-full"
                                        required
                                    />
                                </div>
                                <div className="flex items-end space-x-4">
                                    <div className="flex-grow">
                                        <label htmlFor="creditAmountPerUnit" className="block text-gray-700 text-base font-bold mb-2">
                                            Monto por {creditUnitType === 'gramos' ? 'Kilo' : 'Unidad'}:
                                        </label>
                                        <input
                                            type="number"
                                            id="creditAmountPerUnit"
                                            value={creditAmountPerUnit}
                                            onChange={(e) => setCreditAmountPerUnit(e.target.value)}
                                            placeholder={creditUnitType === 'gramos' ? "Precio/kilo" : "Precio/unidad"}
                                            min="0.01"
                                            step="0.01"
                                            className="w-full"
                                            required
                                        />
                                    </div>
                                    <div className="flex-shrink-0">
                                        <label htmlFor="creditCurrencyPerUnit" className="sr-only">Moneda</label>
                                        <select
                                            id="creditCurrencyPerUnit"
                                            value={creditCurrencyPerUnit}
                                            onChange={(e) => setCreditCurrencyPerUnit(e.target.value)}
                                            className="w-full py-3.5"
                                            disabled={creditUnitType === 'gramos'} // Force USD if selling by grams (price per kilo is usually USD)
                                        >
                                            <option value="USD">USD</option>
                                            <option value="VES">VES</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="md:col-span-2 mt-5">
                                    <button
                                        type="submit"
                                        className="w-full bg-blue-400 text-white py-4.5 px-8 rounded-xl hover:bg-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-plus mr-3">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        {editingCreditSaleId ? 'Actualizar Venta a Crédito' : 'Registrar Venta a Crédito'}
                                    </button>
                                    {editingCreditSaleId && (
                                        <button
                                            type="button"
                                            onClick={handleCancelCreditSaleEdit}
                                            className="mt-4 w-full bg-gray-400 text-white py-3.5 px-8 rounded-xl hover:bg-gray-500 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50 text-lg flex items-center justify-center"
                                        >
                                            Cancelar Edición
                                        </button>
                                    )}
                                </div>
                            </form>
                        </div>
                        
                        {/* Historial de Ventas a Crédito (Generalizado) */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                           <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-clipboard-list text-gray-600">
                                    <rect x="9" y="7" width="10" height="4" rx="1"></rect>
                                    <path d="M15 3h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2"></path>
                                    <path d="M8 7H5"></path>
                                    <path d="M8 12H5"></path>
                                    <path d="M12 17H5"></path>
                                </svg>
                                Historial de Ventas a Crédito
                                </span>
                                {creditSales.length > 0 && (
                                    <button onClick={handleClearCreditSales} className="text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">
                                        Borrar Historial
                                    </button>
                                )}
                            </h2>
                            {/* Credit Sales Filters */}
                            <div className="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="creditSalesSearch" className="block text-gray-700 text-sm font-bold mb-1">Buscar Cliente/Producto:</label>
                                    <input
                                        type="text"
                                        id="creditSalesSearch"
                                        value={creditSalesSearchTerm}
                                        onChange={(e) => setCreditSalesSearchTerm(e.target.value)}
                                        placeholder="Nombre del cliente o producto"
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="creditSalesStatusFilter" className="block text-gray-700 text-sm font-bold mb-1">Filtrar por Estado:</label>
                                    <select
                                        id="creditSalesStatusFilter"
                                        value={creditSalesStatusFilter}
                                        onChange={(e) => setCreditSalesStatusFilter(e.target.value)}
                                        className="w-full text-base"
                                    >
                                        <option value="Todos">Todos</option>
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="Pagado Parcial">Pagado Parcial</option>
                                        <option value="Pagado">Pagado</option>
                                    </select>
                                </div>
                            </div>
                            {paginatedCreditSales.length === 0 ? (
                                <p className="text-gray-600 text-center py-7 text-lg">No hay registros de ventas a crédito que coincidan con los filtros.</p>
                            ) : (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th onClick={() => handleCreditSalesSort('date')}>
                                                        Fecha {creditSalesSortColumn === 'date' && (creditSalesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleCreditSalesSort('customerName')}>
                                                        Cliente {creditSalesSortColumn === 'customerName' && (creditSalesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleCreditSalesSort('productName')}>
                                                        Producto {creditSalesSortColumn === 'productName' && (creditSalesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Cantidad</th>
                                                    <th>Monto/Unidad</th>
                                                    <th onClick={() => handleCreditSalesSort('totalUSD')}>
                                                        Monto Total (USD) {creditSalesSortColumn === 'totalUSD' && (creditSalesSortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Pagado (USD)</th>
                                                    <th>Adeudado (USD)</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paginatedCreditSales.map((sale) => (
                                                    <tr key={sale.id}>
                                                        <td>{sale.date}</td>
                                                        <td>{sale.customerName}</td>
                                                        <td>{sale.productName}</td>
                                                        <td>{sale.quantity} {sale.unitType === 'gramos' ? 'g' : sale.unitType}</td>
                                                        <td>{sale.amountPerUnit.toFixed(2)} {sale.currencyPerUnit}</td>
                                                        <td>
                                                            ${sale.totalUSD.toFixed(2)} USD
                                                            <span className="text-xs text-gray-500 block font-normal">
                                                                ≈ Bs. {(sale.totalUSD * exchangeRate).toFixed(2)} VES
                                                            </span>
                                                        </td>
                                                        <td>${sale.paidAmount.toFixed(2)} USD</td>
                                                        <td className={sale.totalUSD - sale.paidAmount > 0.01 ? 'font-bold text-rose-600' : 'text-emerald-600'}>
                                                            ${(sale.totalUSD - sale.paidAmount).toFixed(2)} USD
                                                        </td>
                                                        <td>
                                                            <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                                                ${sale.status === 'Pagado' ? 'bg-emerald-100 text-emerald-800' :
                                                                  sale.status === 'Pagado Parcial' ? 'bg-amber-100 text-amber-800' :
                                                                  'bg-rose-100 text-rose-800'}`
                                                            }>
                                                                {sale.status}
                                                            </span>
                                                        </td>
                                                        <td className="text-right">
                                                            {sale.status !== 'Pagado' && (
                                                                <button
                                                                    onClick={() => { setPayingCreditSaleId(sale.id); setPaymentAmount(''); }}
                                                                    className="text-blue-600 hover:text-blue-800 p-2 text-xs mr-2"
                                                                >
                                                                    Registrar Pago
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => handleEditCreditSale(sale)}
                                                                className="text-indigo-600 hover:text-indigo-800 p-2 text-xs mr-2"
                                                            >
                                                                Editar
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeleteCreditSale(sale.id)}
                                                                className="text-rose-600 hover:text-rose-800 p-2 text-xs"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex justify-between items-center mt-6">
                                        {filteredAndSortedCreditSales.length > 0 && (
                                            <button
                                                onClick={() => exportToCSV(filteredAndSortedCreditSales, 'ventas_credito.csv', ['id', 'date', 'customerName', 'productName', 'quantity', 'unitType', 'amountPerUnit', 'currencyPerUnit', 'totalUSD', 'paidAmount', 'status'])}
                                                className="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm"
                                            >
                                                Exportar a CSV
                                            </button>
                                        )}
                                        {filteredAndSortedCreditSales.length > ITEMS_PER_PAGE && (
                                            <div className="pagination-container">
                                                <button
                                                    onClick={() => setCurrentCreditSalesPage(prev => Math.max(prev - 1, 1))}
                                                    disabled={currentCreditSalesPage === 1}
                                                    className="pagination-button"
                                                >
                                                    Anterior
                                                </button>
                                                {Array.from({ length: totalCreditSalesPages }, (_, i) => i + 1).map(page => (
                                                    <button
                                                        key={page}
                                                        onClick={() => setCurrentCreditSalesPage(page)}
                                                        className={`pagination-button ${currentCreditSalesPage === page ? 'active' : ''}`}
                                                    >
                                                        {page}
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setCurrentCreditSalesPage(prev => Math.min(prev + 1, totalCreditSalesPages))}
                                                    disabled={currentCreditSalesPage === totalCreditSalesPages}
                                                    className="pagination-button"
                                                >
                                                    Siguiente
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Sección de Gestión de Inventario */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-boxes text-orange-600">
                                        <path d="M2.97 12.93a2 2 0 0 0 0 3.14l1.97 2.63c.41.55 1.05.82 1.69.82h10.72c.64 0 1.28-.27 1.69-.82l1.97-2.63a2 2 0 0 0 0-3.14l-1.97-2.63c-.41-.55-1.05-.82-1.69-.82H6.66c-.64 0-1.28.27-1.69.82Z"></path>
                                        <path d="M7.5 14.5h9"></path>
                                        <path d="M12 2v2"></path>
                                        <path d="M12 22v-2"></path>
                                        <path d="M16 4h2"></path>
                                        <path d="M6 4H8"></path>
                                        <path d="M16 20h2"></path>
                                        <path d="M6 20H8"></path>
                                        <path d="M2 12h2"></path>
                                        <path d="M20 12h2"></path>
                                    </svg>
                                    Gestión de Inventario
                                </span>
                            </h2>
                            <form onSubmit={handleAddOrUpdateInventoryItem} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label htmlFor="inventoryProductName" className="block text-gray-700 text-base font-bold mb-2">Nombre del Producto:</label>
                                    <input
                                        type="text"
                                        id="inventoryProductName"
                                        value={newInventoryItem.name}
                                        onChange={(e) => setNewInventoryItem({ ...newInventoryItem, name: e.target.value })}
                                        className="w-full"
                                        placeholder="Ej: Leche, Huevos, Queso"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="inventoryStockQuantity" className="block text-gray-700 text-base font-bold mb-2">Cantidad en Stock:</label>
                                    <input
                                        type="number"
                                        id="inventoryStockQuantity"
                                        value={newInventoryItem.stockQuantity}
                                        onChange={(e) => setNewInventoryItem({ ...newInventoryItem, stockQuantity: e.target.value })}
                                        className="w-full"
                                        placeholder="Ej: 100 (unidades) o 5000 (gramos)"
                                        min="0"
                                        step="0.01"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="inventoryStockUnitType" className="block text-gray-700 text-base font-bold mb-2">Tipo de Unidad:</label>
                                    <select
                                        id="inventoryStockUnitType"
                                        value={newInventoryItem.stockUnitType}
                                        onChange={(e) => setNewInventoryItem({ ...newInventoryItem, stockUnitType: e.target.value })}
                                        className="w-full"
                                    >
                                        <option value="unidades">Unidades</option>
                                        <option value="gramos">Gramos</option>
                                    </select>
                                </div>
                                <div className="flex items-end space-x-4">
                                    <div className="flex-grow">
                                        <label htmlFor="inventoryTotalCostPurchase" className="block text-gray-700 text-base font-bold mb-2">Costo Total de Compra:</label>
                                        <input
                                            type="number"
                                            id="inventoryTotalCostPurchase"
                                            value={newInventoryItem.totalCostPurchase}
                                            onChange={(e) => setNewInventoryItem({ ...newInventoryItem, totalCostPurchase: e.target.value })}
                                            className="w-full"
                                            placeholder="Ej: 150.00"
                                            min="0"
                                            step="0.01"
                                            required
                                        />
                                    </div>
                                    <div className="flex-shrink-0">
                                        <label htmlFor="inventoryTotalCostPurchaseCurrency" className="sr-only">Moneda</label>
                                        <select
                                            id="inventoryTotalCostPurchaseCurrency"
                                            value={newInventoryItem.totalCostPurchaseCurrency}
                                            onChange={(e) => setNewInventoryItem({ ...newInventoryItem, totalCostPurchaseCurrency: e.target.value })}
                                            className="w-full py-3.5"
                                        >
                                            <option value="USD">USD</option>
                                            <option value="VES">VES</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex items-end space-x-4">
                                    <div className="flex-grow">
                                        <label htmlFor="inventorySuggestedSellingPrice" className="block text-gray-700 text-base font-bold mb-2">Precio de Venta Sugerido:</label>
                                        <input
                                            type="number"
                                            id="inventorySuggestedSellingPrice"
                                            value={newInventoryItem.suggestedSellingPrice}
                                            onChange={(e) => setNewInventoryItem({ ...newInventoryItem, suggestedSellingPrice: e.target.value })}
                                            className="w-full"
                                            placeholder="Ej: 1.80 (por unidad) o 0.005 (por gramo)"
                                            min="0"
                                            step="0.01"
                                            required
                                        />
                                    </div>
                                    <div className="flex-shrink-0">
                                        <label htmlFor="inventorySuggestedSellingPriceCurrency" className="sr-only">Moneda</label>
                                        <select
                                            id="inventorySuggestedSellingPriceCurrency"
                                            value={newInventoryItem.suggestedSellingPriceCurrency}
                                            onChange={(e) => setNewInventoryItem({ ...newInventoryItem, suggestedSellingPriceCurrency: e.target.value })}
                                            className="w-full py-3.5"
                                        >
                                            <option value="USD">USD</option>
                                            <option value="VES">VES</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label htmlFor="inventoryMinStockAlert" className="block text-gray-700 text-base font-bold mb-2">Alerta de Stock Mínimo:</label>
                                    <input
                                        type="number"
                                        id="inventoryMinStockAlert"
                                        value={newInventoryItem.minStockAlert}
                                        onChange={(e) => setNewInventoryItem({ ...newInventoryItem, minStockAlert: e.target.value })}
                                        className="w-full"
                                        placeholder="Ej: 10 (unidades) o 1000 (gramos)"
                                        min="0"
                                        step="0.01"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="inventoryCategory" className="block text-gray-700 text-base font-bold mb-2">Categoría:</label>
                                    <input
                                        type="text"
                                        id="inventoryCategory"
                                        value={newInventoryItem.category}
                                        onChange={(e) => setNewInventoryItem({ ...newInventoryItem, category: e.target.value })}
                                        className="w-full"
                                        placeholder="Ej: Lácteos, Granos, Bebidas"
                                        required
                                    />
                                </div>
                                <div className="md:col-span-2 mt-5">
                                    <button
                                        type="submit"
                                        className="w-full bg-orange-500 text-white py-4.5 px-8 rounded-xl hover:bg-orange-600 focus:outline-none focus:ring-4 focus:ring-orange-300 focus:ring-opacity-50 text-xl flex items-center justify-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-package-plus mr-3">
                                            <path d="M16 16h2l2-2V6l-2-2H6l-2 2v7"></path>
                                            <path d="M2 12h10"></path>
                                            <path d="M12 2L8 6"></path>
                                            <path d="M12 2l4 4"></path>
                                            <path d="M12 22v-8"></path>
                                            <path d="M9 15h6"></path>
                                        </svg>
                                        {editingInventoryItem ? 'Actualizar Producto' : 'Añadir Producto al Inventario'}
                                    </button>
                                    {editingInventoryItem && (
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setEditingInventoryItem(null);
                                                setNewInventoryItem({ name: '', stockQuantity: '', stockUnitType: 'unidades', totalCostPurchase: '', totalCostPurchaseCurrency: 'USD', suggestedSellingPrice: '', suggestedSellingPriceCurrency: 'USD', minStockAlert: '', category: 'General' });
                                            }}
                                            className="mt-4 w-full bg-gray-400 text-white py-3.5 px-8 rounded-xl hover:bg-gray-500 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50 text-lg flex items-center justify-center"
                                        >
                                            Cancelar Edición
                                        </button>
                                    )}
                                </div>
                            </form>

                            <h3 className="text-xl font-bold text-gray-800 mt-12 mb-6">Inventario Actual:</h3>
                            {/* Inventory Filters */}
                            <div className="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="inventorySearch" className="block text-gray-700 text-sm font-bold mb-1">Buscar Producto:</label>
                                    <input
                                        type="text"
                                        id="inventorySearch"
                                        value={inventorySearchTerm}
                                        onChange={(e) => setInventorySearchTerm(e.target.value)}
                                        placeholder="Nombre del producto"
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="inventoryCategoryFilter" className="block text-gray-700 text-sm font-bold mb-1">Filtrar por Categoría:</label>
                                    <select
                                        id="inventoryCategoryFilter"
                                        value={inventoryCategoryFilter}
                                        onChange={(e) => setInventoryCategoryFilter(e.target.value)}
                                        className="w-full text-base"
                                    >
                                        {uniqueInventoryCategories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            {paginatedInventory.length === 0 ? (
                                <p className="text-gray-600 text-center py-7 text-lg">No hay productos en el inventario que coincidan con los filtros.</p>
                            ) : (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead>
                                                <tr>
                                                    <th onClick={() => handleInventorySort('name')}>
                                                        Producto {inventorySortColumn === 'name' && (inventorySortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleInventorySort('stockQuantity')}>
                                                        Stock {inventorySortColumn === 'stockQuantity' && (inventorySortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Unidad</th>
                                                    <th onClick={() => handleInventorySort('category')}>Categoría</th>
                                                    <th onClick={() => handleInventorySort('costPerUnit')}>
                                                        Costo/Unidad (USD) {inventorySortColumn === 'costPerUnit' && (inventorySortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleInventorySort('suggestedSellingPrice')}>
                                                        Venta Sugerida (USD/VES) {inventorySortColumn === 'suggestedSellingPrice' && (inventorySortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleInventorySort('lastUpdated')}>
                                                        Última Actualización {inventorySortColumn === 'lastUpdated' && (inventorySortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paginatedInventory.map((item) => (
                                                    <tr key={item.id} className={item.stockQuantity <= item.minStockAlert && item.minStockAlert > 0 ? 'bg-amber-50' : ''}>
                                                        <td>{item.name}</td>
                                                        <td>
                                                            {item.stockQuantity.toFixed(2)}
                                                            {item.stockQuantity <= item.minStockAlert && item.minStockAlert > 0 && (
                                                                <span className="ml-2 text-rose-600 font-semibold text-sm">
                                                                    (Bajo Stock!)
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td>{item.stockUnitType}</td>
                                                        <td>{item.category}</td>
                                                        <td>
                                                            ${item.costPerUnit.toFixed(3)} USD
                                                            <span className="text-xs text-gray-500 block font-normal">
                                                                (≈ Bs. {(convertToVESFromUSD(item.costPerUnit)).toFixed(2)} VES)
                                                            </span>
                                                        </td>
                                                        <td>
                                                            {item.suggestedSellingPriceCurrency === 'USD' ? '$' : 'Bs. '}
                                                            {item.suggestedSellingPrice.toFixed(2)} {item.suggestedSellingPriceCurrency}
                                                            <span className="text-xs text-gray-500 block font-normal">
                                                                {item.suggestedSellingPriceCurrency === 'USD' ?
                                                                    `(≈ Bs. ${(convertToVESFromUSD(item.suggestedSellingPrice)).toFixed(2)} VES)` :
                                                                    `(≈ $${(convertToUSDFromAny(item.suggestedSellingPrice, item.suggestedSellingPriceCurrency)).toFixed(2)} USD)`
                                                                }
                                                            </span>
                                                        </td>
                                                        <td>{item.lastUpdated}</td>
                                                        <td className="text-right">
                                                            <button
                                                                onClick={() => handleEditInventoryItem(item)}
                                                                className="text-blue-600 hover:text-blue-800 p-2 text-xs mr-2"
                                                            >
                                                                Editar
                                                            </button>
                                                            <button
                                                                onClick={() => openConfirmModal('¿Estás seguro de que quieres eliminar este producto del inventario?', () => handleDeleteInventoryItem(item.id))}
                                                                className="text-rose-600 hover:text-rose-800 p-2 text-xs"
                                                            >
                                                                Eliminar
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex justify-between items-center mt-6">
                                        {filteredAndSortedInventory.length > 0 && (
                                            <button
                                                onClick={() => exportToCSV(filteredAndSortedInventory, 'inventario.csv', ['id', 'name', 'stockQuantity', 'stockUnitType', 'totalCostPurchase', 'totalCostPurchaseCurrency', 'costPerUnit', 'suggestedSellingPrice', 'suggestedSellingPriceCurrency', 'minStockAlert', 'category', 'lastUpdated'])}
                                                className="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm"
                                            >
                                                Exportar a CSV
                                            </button>
                                        )}
                                        {filteredAndSortedInventory.length > ITEMS_PER_PAGE && (
                                            <div className="pagination-container">
                                                <button
                                                    onClick={() => setCurrentInventoryPage(prev => Math.max(prev - 1, 1))}
                                                    disabled={currentInventoryPage === 1}
                                                    className="pagination-button"
                                                >
                                                    Anterior
                                                </button>
                                                {Array.from({ length: totalInventoryPages }, (_, i) => i + 1).map(page => (
                                                    <button
                                                        key={page}
                                                        onClick={() => setCurrentInventoryPage(page)}
                                                        className={`pagination-button ${currentInventoryPage === page ? 'active' : ''}`}
                                                    >
                                                        {page}
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setCurrentInventoryPage(prev => Math.min(prev + 1, totalInventoryPages))}
                                                    disabled={currentInventoryPage === totalInventoryPages}
                                                    className="pagination-button"
                                                >
                                                    Siguiente
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    {inventory.length > 0 && (
                                        <div className="text-center mt-8">
                                            <button onClick={handleClearInventory} className="text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">
                                                Borrar Inventario Completo
                                            </button>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* Sección de Reportes */}
                        <div className="mb-16 p-9 bg-white rounded-3xl shadow-2xl border border-gray-100">
                            <h2 className="section-heading">
                                <span className="section-heading-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-bar-chart-2 text-teal-600">
                                    <line x1="18" y1="20" x2="18" y2="10"></line>
                                    <line x1="12" y1="20" x2="12" y2="4"></line>
                                    <line x1="6" y1="20" x2="6" y2="14"></line>
                                </svg>
                                Reportes Rápidos
                                </span>
                            </h2>
                            {/* Report Filters */}
                            <div className="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="reportStartDate" className="block text-gray-700 text-sm font-bold mb-1">Fecha Inicio Reporte:</label>
                                    <input
                                        type="date"
                                        id="reportStartDate"
                                        value={reportStartDate}
                                        onChange={(e) => setReportStartDate(e.target.value)}
                                        className="w-full text-base"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="reportEndDate" className="block text-gray-700 text-sm font-bold mb-1">Fecha Fin Reporte:</label>
                                    <input
                                        type="date"
                                        id="reportEndDate"
                                        value={reportEndDate}
                                        onChange={(e) => setReportEndDate(e.target.value)}
                                        className="w-full text-base"
                                    />
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                {/* Resumen de Ventas por Producto */}
                                <div className="p-6 bg-teal-50 border border-teal-100 rounded-2xl shadow-inner">
                                    <h3 className="text-xl font-semibold text-teal-800 mb-4">Ventas por Producto (USD)</h3>
                                    {salesSummaryByProduct.length === 0 ? (
                                        <p className="text-gray-600">No hay datos de ventas por producto para el período seleccionado.</p>
                                    ) : (
                                        <>
                                            <ul>
                                                {salesSummaryByProduct.map(([product, total], index) => (
                                                    <li key={index} className="flex justify-between items-center py-2 border-b border-teal-200 last:border-b-0">
                                                        <span className="text-gray-700 font-medium">{product}:</span>
                                                        <span className="font-bold text-teal-700">${total.toFixed(2)}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                            <button
                                                onClick={() => exportToCSV(salesSummaryByProduct.map(([product, total]) => ({ product, totalUSD: total })), 'ventas_por_producto.csv', ['product', 'totalUSD'])}
                                                className="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm w-full"
                                            >
                                                Exportar a CSV
                                            </button>
                                        </>
                                    )}
                                </div>

                                {/* Resumen de Gastos por Categoría */}
                                <div className="p-6 bg-rose-50 border border-rose-100 rounded-2xl shadow-inner">
                                    <h3 className="text-xl font-semibold text-rose-800 mb-4">Gastos por Categoría (USD)</h3>
                                    {expensesSummaryByCategory.length === 0 ? (
                                        <p className="text-gray-600">No hay datos de gastos por categoría para el período seleccionado.</p>
                                    ) : (
                                        <>
                                            <ul>
                                                {expensesSummaryByCategory.map(([category, total], index) => (
                                                    <li key={index} className="flex justify-between items-center py-2 border-b border-rose-200 last:border-b-0">
                                                        <span className="text-gray-700 font-medium">{category}:</span>
                                                        <span className="font-bold text-rose-700">${total.toFixed(2)}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                            <button
                                                onClick={() => exportToCSV(expensesSummaryByCategory.map(([category, total]) => ({ category, totalUSD: total }), 'gastos_por_categoria.csv', ['category', 'totalUSD']))}
                                                className="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm w-full"
                                            >
                                                Exportar a CSV
                                            </button>
                                        </>
                                    )}
                                </div>

                                {/* Nuevo Reporte: Ventas por Método de Pago */}
                                <div className="p-6 bg-blue-50 border border-blue-100 rounded-2xl shadow-inner">
                                    <h3 className="text-xl font-semibold text-blue-800 mb-4">Ventas por Método de Pago (USD)</h3>
                                    {salesSummaryByPaymentMethod.length === 0 ? (
                                        <p className="text-gray-600">No hay datos de ventas por método de pago para el período seleccionado.</p>
                                    ) : (
                                        <>
                                            <ul>
                                                {salesSummaryByPaymentMethod.map(([method, total], index) => (
                                                    <li key={index} className="flex justify-between items-center py-2 border-b border-blue-200 last:border-b-0">
                                                        <span className="text-gray-700 font-medium">{method}:</span>
                                                        <span className="font-bold text-blue-700">${total.toFixed(2)}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                            <button
                                                onClick={() => exportToCSV(salesSummaryByPaymentMethod.map(([method, total]) => ({ paymentMethod: method, totalUSD: total })), 'ventas_por_metodo_pago.csv', ['paymentMethod', 'totalUSD'])}
                                                className="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm w-full"
                                            >
                                                Exportar a CSV
                                            </button>
                                        </>
                                    )}
                                </div>

                                {/* Nuevo Reporte: Rentabilidad por Producto */}
                                <div className="p-6 bg-purple-50 border border-purple-100 rounded-2xl shadow-inner">
                                    <h3 className="text-xl font-semibold text-purple-800 mb-4">Rentabilidad por Producto</h3>
                                    {profitabilityByProduct.length === 0 ? (
                                        <p className="text-gray-600">No hay datos de rentabilidad por producto para el período seleccionado.</p>
                                    ) : (
                                        <>
                                            <ul>
                                                {profitabilityByProduct.map((data, index) => (
                                                    <li key={index} className="py-2 border-b border-purple-200 last:border-b-0">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-gray-700 font-medium">{data.product}:</span>
                                                            <span className={`font-bold ${data.profitUSD >= 0 ? 'text-emerald-700' : 'text-rose-700'}`}>
                                                                ${data.profitUSD.toFixed(2)} ({data.profitPercentage.toFixed(2)}%)
                                                            </span>
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            Ventas: ${data.totalRevenueUSD.toFixed(2)} | Costo: ${data.totalCostUSD.toFixed(2)}
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                            <button
                                                onClick={() => exportToCSV(profitabilityByProduct, 'rentabilidad_por_producto.csv', ['product', 'totalRevenueUSD', 'totalCostUSD', 'profitUSD', 'profitPercentage'])}
                                                className="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm w-full"
                                            >
                                                Exportar a CSV
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
